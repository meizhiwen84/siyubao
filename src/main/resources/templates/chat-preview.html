<!DOCTYPE html>
<html lang="zh-CN" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>èŠå¤©é¢„è§ˆç•Œé¢</title>
    <link href="/xhs/font-awesome.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            backdrop-filter: blur(10px);
        }

        .header {
            background: linear-gradient(90deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 20px;
            text-align: center;
            position: relative;
        }

        .header h1 {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .header p {
            opacity: 0.9;
            font-size: 14px;
        }

        .home-nav-btn {
            position: absolute;
            left: 20px;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.3);
            padding: 8px 16px;
            border-radius: 25px;
            text-decoration: none;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .home-nav-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.5);
            transform: translateY(-50%) scale(1.05);
            color: white;
            text-decoration: none;
        }

        .home-nav-btn i {
            font-size: 12px;
        }

        .main-content {
            padding: 30px;
        }

        .top-section {
            display: flex;
            gap: 30px;
            margin-bottom: 30px;
            min-height: 600px;
            align-items: flex-end;
        }

        .left-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .input-label {
            font-size: 16px;
            font-weight: 600;
            color: #333;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .input-label::before {
            content: 'âœï¸';
            font-size: 18px;
        }

        .text-input {
            width: 100%;
            height: 100%;
            min-height: 400px;
            padding: 20px;
            border: 2px solid #e1e5e9;
            border-radius: 12px;
            font-size: 14px;
            line-height: 1.6;
            resize: vertical;
            font-family: inherit;
            transition: all 0.3s ease;
            background: #fafbfc;
        }

        .text-input:focus {
            outline: none;
            border-color: #4facfe;
            box-shadow: 0 0 0 3px rgba(79, 172, 254, 0.1);
            background: white;
        }

        /* æ–°çš„æ–‡æœ¬è¾“å…¥ç»„ä»¶æ ·å¼ */
        .text-input-container {
            width: 100%;
            min-height: 400px;
            border: 2px solid #e1e5e9;
            border-radius: 12px;
            background: #fafbfc;
            transition: all 0.3s ease;
            overflow: hidden;
        }

        .text-input-container:focus-within {
            border-color: #4facfe;
            box-shadow: 0 0 0 3px rgba(79, 172, 254, 0.1);
            background: white;
        }

        .text-input-lines {
            padding: 20px;
            max-height: 350px;
            overflow-y: auto;
        }

        .input-line {
            display: flex;
            align-items: flex-start;
            margin-bottom: 8px;
            min-height: 24px;
            position: relative;
            group: line;
            /* è·¨æµè§ˆå™¨å…¼å®¹æ€§ */
            -webkit-transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            -moz-transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            -o-transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            -webkit-transform: translateX(0);
            -moz-transform: translateX(0);
            -ms-transform: translateX(0);
            transform: translateX(0);
        }

        .input-line:last-child {
            margin-bottom: 0;
        }

        .line-content {
            flex: 1;
            min-height: 24px;
            line-height: 1.6;
            font-size: 14px;
            font-family: inherit;
            outline: none;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: none;
            background: transparent;
            padding: 2px 4px;
            border-radius: 4px;
            transition: background-color 0.2s ease;
            word-wrap: break-word;
            white-space: pre-wrap;
            user-select: text; /* å…è®¸æ–‡æœ¬é€‰æ‹© */
        }

        .line-content:hover {
            background-color: rgba(79, 172, 254, 0.05);
        }

        .line-content:focus {
            background-color: rgba(79, 172, 254, 0.1);
        }

        .line-content[data-placeholder]:empty::before {
            content: attr(data-placeholder);
            color: #999;
            font-style: italic;
        }

        .line-actions {
            display: flex;
            gap: 4px;
            margin-left: 8px;
            margin-top: 2px;
            opacity: 0;
            transition: all 0.2s ease;
        }

        .input-line:hover .line-actions {
            opacity: 1;
        }

        .delete-line-btn, .insert-above-btn {
            width: 20px;
            height: 20px;
            border: none;
            color: white;
            border-radius: 50%;
            font-size: 12px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .delete-line-btn {
            background: #ff4757;
        }

        .delete-line-btn:hover {
            background: #ff3742;
            transform: scale(1.1);
        }

        .delete-line-btn.batch-selected {
            background: #ff1744;
            box-shadow: 0 0 0 2px #fff, 0 0 0 4px #ff1744;
            transform: scale(1.1);
        }

        .batch-delete-mode .delete-line-btn {
            position: relative;
        }

        .batch-delete-mode .delete-line-btn::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            border: 2px solid transparent;
            border-radius: 50%;
            transition: all 0.2s ease;
        }

        .batch-delete-mode .delete-line-btn:hover::before {
            border-color: #ff4757;
        }

        .batch-delete-toolbar {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
            border: none;
            border-radius: 12px;
            padding: 12px;
            box-shadow: 0 8px 32px rgba(255, 107, 107, 0.3);
            display: none;
            z-index: 1000;
            gap: 8px;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .batch-delete-toolbar button {
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            transition: all 0.2s ease;
            backdrop-filter: blur(5px);
        }

        .batch-delete-enter {
            background: rgba(255, 255, 255, 0.2);
            color: white;
        }

        .batch-delete-enter:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .batch-delete-confirm {
            background: rgba(255, 255, 255, 0.2);
            color: white;
        }

        .batch-delete-confirm:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .batch-delete-cancel {
            background: rgba(255, 255, 255, 0.2);
            color: white;
        }

        .batch-delete-cancel:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .clear-all-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            margin-left: 8px;
        }

        .clear-all-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        /* åˆ é™¤ç¡®è®¤å¯¹è¯æ¡†æ ·å¼ */
        .delete-confirmation-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 10000;
        }

        .delete-confirmation-dialog {
            background: white;
            border-radius: 8px;
            padding: 24px;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            animation: dialogSlideIn 0.3s ease-out;
        }

        @keyframes dialogSlideIn {
            from {
                opacity: 0;
                transform: translateY(-20px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .delete-confirmation-title {
            font-size: 18px;
            font-weight: 600;
            color: #dc3545;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .delete-confirmation-message {
            color: #666;
            margin-bottom: 20px;
            line-height: 1.5;
        }

        .delete-confirmation-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        .delete-confirmation-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .delete-confirmation-cancel {
            background-color: #f8f9fa;
            color: #6c757d;
            border: 1px solid #dee2e6;
        }

        .delete-confirmation-cancel:hover {
            background-color: #e9ecef;
        }

        .delete-confirmation-confirm {
            background-color: #dc3545;
            color: white;
        }

        .delete-confirmation-confirm:hover {
            background-color: #c82333;
        }

        /* æ’¤é”€åŠŸèƒ½æ ·å¼ */
        .undo-notification {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: #333;
            color: white;
            padding: 12px 20px;
            border-radius: 6px;
            display: none;
            align-items: center;
            gap: 12px;
            z-index: 9999;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            animation: undoSlideUp 0.3s ease-out;
        }

        @keyframes undoSlideUp {
            from {
                opacity: 0;
                transform: translateX(-50%) translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
        }

        .undo-message {
            font-size: 14px;
        }

        .undo-btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            transition: background-color 0.2s ease;
        }

        .undo-btn:hover {
            background: #0056b3;
        }

        .undo-close {
            background: none;
            border: none;
            color: #ccc;
            cursor: pointer;
            font-size: 16px;
            padding: 0;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .undo-close:hover {
            color: white;
        }

        .insert-above-btn {
            background: #2ed573;
        }

        .insert-above-btn:hover {
            background: #26d065;
            transform: scale(1.1);
        }

        .add-line-btn-container {
            padding: 10px 20px;
            border-top: 1px solid #e1e5e9;
            background: #f8f9fa;
        }

        .add-line-btn {
            width: 100%;
            padding: 8px 16px;
            border: 1px dashed #4facfe;
            background: transparent;
            color: #4facfe;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .add-line-btn:hover {
            background: rgba(79, 172, 254, 0.1);
            border-style: solid;
        }

        /* å¤šè¡Œæ–‡æœ¬é€‰æ‹©æ ·å¼ */
        .text-input-lines {
            position: relative;
            user-select: text; /* å…è®¸æ–‡æœ¬é€‰æ‹© */
        }

        .line-content.selecting {
            user-select: none;
        }

        .input-line.selected {
            background: rgba(79, 172, 254, 0.25);
            border-radius: 6px;
            margin: 2px 0;
            border: 1px solid rgba(79, 172, 254, 0.4);
            box-shadow: 0 2px 4px rgba(79, 172, 254, 0.2);
            /* è·¨æµè§ˆå™¨å…¼å®¹æ€§ */
            -webkit-transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            -moz-transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            -o-transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            -webkit-transform: translateX(2px);
            -moz-transform: translateX(2px);
            -ms-transform: translateX(2px);
            transform: translateX(2px);
        }

        .input-line.selected .line-content {
            background: rgba(79, 172, 254, 0.3);
            color: #1a365d;
            font-weight: 500;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* é”®ç›˜ç„¦ç‚¹è¡Œæ ·å¼ */
        .input-line.keyboard-focus {
            background: rgba(255, 193, 7, 0.2);
            border-radius: 6px;
            margin: 2px 0;
            border: 2px solid rgba(255, 193, 7, 0.6);
            box-shadow: 0 0 8px rgba(255, 193, 7, 0.3);
            transition: all 0.2s ease;
        }

        .input-line.keyboard-focus .line-content {
            background: rgba(255, 193, 7, 0.25);
            color: #856404;
            font-weight: 500;
        }

        .input-line.selection-start {
            background: linear-gradient(to bottom, transparent 0%, rgba(79, 172, 254, 0.15) 50%);
        }

        .input-line.selection-end {
            background: linear-gradient(to bottom, rgba(79, 172, 254, 0.15) 50%, transparent 100%);
        }

        .input-line.selection-middle {
            background: rgba(79, 172, 254, 0.15);
        }

        /* é€‰æ‹©æŒ‡ç¤ºå™¨ */
        .selection-indicator {
            position: absolute;
            left: 0;
            width: 3px;
            background: #4facfe;
            border-radius: 2px;
            opacity: 0;
            transition: opacity 0.2s ease;
            z-index: 10;
        }

        .selection-indicator.active {
            opacity: 1;
        }

        /* é€‰æ‹©å·¥å…·æ  */
        .selection-toolbar {
            position: fixed;
            bottom: 80px;
            right: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(102, 126, 234, 0.3);
            padding: 12px;
            display: none;
            z-index: 1000;
            gap: 8px;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .selection-toolbar.active {
            display: flex;
        }

        .selection-toolbar button {
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            backdrop-filter: blur(5px);
        }

        .selection-toolbar button:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }
        .right-panel {
            flex: 0 0 375px;
            display: flex;
            flex-direction: column;
        }

        .preview-label {
            font-size: 16px;
            font-weight: 600;
            color: #333;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .preview-label::before {
            content: 'ğŸ“±';
            font-size: 18px;
        }

        .phone-container {
            background: #000;
            border-radius: 25px;
            padding: 8px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            position: relative;
            overflow: hidden;
        }

        .phone-container::before {
            content: '';
            position: absolute;
            top: 15px;
            left: 50%;
            transform: translateX(-50%);
            width: 60px;
            height: 4px;
            background: #333;
            border-radius: 2px;
            z-index: 10;
        }

        .phone-iframe {
            width: 375px;
            height: 800px;
            border: none;
            border-radius: 20px;
            background: white;
            display: block;
            transition: all 0.3s ease;
        }

        .bottom-section {
            text-align: center;
            padding: 20px 0;
        }

        .generate-btn {
            background: linear-gradient(45deg, #ff6b6b, #ee5a24);
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 16px;
            font-weight: 600;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(255, 107, 107, 0.3);
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            overflow: hidden;
        }

        .generate-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }

        .generate-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 107, 107, 0.4);
        }

        .generate-btn:hover::before {
            left: 100%;
        }

        .generate-btn:active {
            transform: translateY(0);
        }

        .char-counter {
            text-align: right;
            margin-top: 8px;
            font-size: 12px;
            color: #666;
        }

        .region-select {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e1e5e9;
            border-radius: 12px;
            font-size: 14px;
            font-family: inherit;
            background: #fafbfc;
            transition: all 0.3s ease;
            margin-bottom: 20px;
            cursor: pointer;
        }

        .region-select:focus {
            outline: none;
            border-color: #4facfe;
            box-shadow: 0 0 0 3px rgba(79, 172, 254, 0.1);
            background: white;
        }

        .region-select:hover {
            border-color: #4facfe;
        }

        .content-rules {
            background: #f8f9fa;
            border: 1px solid #dc3545;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            font-size: 13px;
            line-height: 1.5;
            display: none;
        }

        .content-rules p {
            margin: 0 0 8px 0;
            color: #495057;
        }

        .content-rules p:last-child {
            margin-bottom: 0;
        }

        .content-rules strong {
            color: #343a40;
            font-weight: 600;
        }

        /* é…ç½®é“¾æ¥æ ·å¼ */
        .config-link {
            color: #6c757d;
            font-size: 12px;
            text-decoration: none;
            margin-left: 8px;
            opacity: 0.7;
            transition: all 0.2s ease;
            font-weight: normal;
        }

        .config-link:hover {
            color: #4facfe;
            opacity: 1;
            text-decoration: underline;
        }

        /* é†’ç›®çš„æ¸…ç©ºæŒ‰é’®æ ·å¼ */
        .clear-input-btn {
            background: linear-gradient(135deg, #ff6b35, #f7931e);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            margin-left: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(255, 107, 53, 0.3);
            position: relative;
            overflow: hidden;
        }

        .clear-input-btn:hover {
            background: linear-gradient(135deg, #e55a2b, #e8851a);
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(255, 107, 53, 0.4);
        }

        .clear-input-btn:active {
            transform: translateY(0);
            box-shadow: 0 2px 8px rgba(255, 107, 53, 0.3);
        }

        .clear-input-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }

        .clear-input-btn:hover::before {
            left: 100%;
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }

            .main-content {
                padding: 20px;
            }

            .top-section {
                flex-direction: column;
                gap: 20px;
            }

            .right-panel {
                flex: none;
                align-self: center;
            }

            .phone-container {
                transform: scale(0.8);
                margin: 0 auto;
            }

            .text-input {
                min-height: 300px;
            }

            .header h1 {
                font-size: 20px;
            }
        }

        @media (max-width: 480px) {
            .phone-container {
                transform: scale(0.7);
            }

            .generate-btn {
                padding: 12px 30px;
                font-size: 14px;
                top: 15px;
                right: 15px;
            }
        }

        /* åŠ è½½åŠ¨ç”» */
        .loading {
            position: relative;
        }

        .loading::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 20px;
            height: 20px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #4facfe;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: translate(-50%, -50%) rotate(0deg); }
            100% { transform: translate(-50%, -50%) rotate(360deg); }
        }

        /* å¹³æ»‘è¿‡æ¸¡æ•ˆæœ */
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* é”™è¯¯æç¤ºæ ·å¼ */
        .error-toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(45deg, #ff6b6b, #ee5a24);
            color: white;
            padding: 15px 20px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(255, 107, 107, 0.3);
            z-index: 1000;
            font-size: 14px;
            font-weight: 500;
            max-width: 300px;
            transform: translateX(100%);
            transition: transform 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .error-toast.show {
            transform: translateX(0);
        }

        .error-toast::before {
            content: 'âš ï¸';
            font-size: 16px;
        }

        .error-toast .close-btn {
            background: none;
            border: none;
            color: white;
            font-size: 18px;
            cursor: pointer;
            padding: 0;
            margin-left: auto;
            opacity: 0.8;
            transition: opacity 0.2s;
        }

        .error-toast .close-btn:hover {
            opacity: 1;
        }

        /* é€‰æ‹©æ¡†é”™è¯¯çŠ¶æ€æ ·å¼ */
        .region-select.error {
            border-color: #ff6b6b;
            box-shadow: 0 0 0 3px rgba(255, 107, 107, 0.1);
            background: #fff5f5;
        }

        /* å›¾ç‰‡ç²˜è´´åŒºåŸŸæ ·å¼ */
        .image-paste-section {
            margin-top: 15px;
        }

        .ocr-hint {
            font-size: 12px;
            color: #666;
            font-weight: normal;
            margin-left: 8px;
        }

        .image-paste-area {
            border: 2px dashed #d1d5db;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            background: #f9fafb;
            transition: all 0.3s ease;
            min-height: 120px;
            position: relative;
        }

        .image-paste-area:hover {
            border-color: #4facfe;
            background: #f0f9ff;
        }

        .image-paste-area.dragover {
            border-color: #4facfe;
            background: #e0f2fe;
            transform: scale(1.02);
        }

        .paste-placeholder {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
        }

        .paste-icon {
            font-size: 32px;
            margin-bottom: 10px;
            opacity: 0.6;
        }

        .paste-text {
            font-size: 16px;
            font-weight: 500;
            color: #374151;
            margin-bottom: 5px;
        }

        .paste-subtext {
            font-size: 12px;
            color: #6b7280;
        }

        .image-preview {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
        }

        .image-preview img {
            max-width: 100%;
            max-height: 200px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .image-actions {
            display: flex;
            gap: 10px;
        }

        .ocr-btn, .clear-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: 500;
        }

        .ocr-btn {
            background: #4facfe;
            color: white;
        }

        .ocr-btn:hover {
            background: #2563eb;
            transform: translateY(-1px);
        }

        .clear-btn {
            background: #ef4444;
            color: white;
        }

        .clear-btn:hover {
            background: #dc2626;
            transform: translateY(-1px);
        }

        .ocr-result {
            margin-top: 15px;
            padding: 15px;
            background: #f0f9ff;
            border-radius: 8px;
            border-left: 4px solid #4facfe;
        }

        .ocr-status {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 14px;
            color: #1e40af;
        }

        .loading-spinner {
            width: 16px;
            height: 16px;
            border: 2px solid #e5e7eb;
            border-top: 2px solid #4facfe;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .ocr-text {
            margin-top: 10px;
            padding: 10px;
            background: white;
            border-radius: 6px;
            border: 1px solid #e5e7eb;
            font-size: 14px;
            line-height: 1.5;
            color: #374151;
            white-space: pre-wrap;
        }

        /* æ¨¡æ€å¼¹çª—æ ·å¼ */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            backdrop-filter: blur(5px);
        }

        .modal-overlay.show {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 16px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
            transform: scale(0.9);
            transition: transform 0.3s ease;
            position: relative;
        }

        .modal-overlay.show .modal-content {
            transform: scale(1);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f1f3f4;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 600;
            color: #333;
            margin: 0;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            color: #666;
            cursor: pointer;
            padding: 5px;
            border-radius: 50%;
            transition: all 0.2s ease;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-close:hover {
            background: #f1f3f4;
            color: #333;
        }

        .modal-body {
            line-height: 1.6;
        }

        .modal-body h3 {
            color: #333;
            font-size: 16px;
            font-weight: 600;
            margin: 20px 0 10px 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .modal-body h3:first-child {
            margin-top: 0;
        }

        .modal-body h3::before {
            content: 'ğŸ“';
            font-size: 18px;
        }

        .modal-body ul {
            margin: 10px 0;
            padding-left: 20px;
        }

        .modal-body li {
            margin: 8px 0;
            color: #555;
            font-size: 14px;
        }

        .modal-body strong {
            color: #333;
            font-weight: 600;
        }

        .modal-body .example {
            background: #f8f9fa;
            border-left: 4px solid #4facfe;
            padding: 15px;
            margin: 15px 0;
            border-radius: 0 8px 8px 0;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.5;
        }

        .modal-body .example-title {
            font-weight: 600;
            color: #4facfe;
            margin-bottom: 8px;
            font-family: inherit;
        }
    </style>
</head>
<body>
    <div class="container fade-in">
        <div class="header">
            <a href="/" class="home-nav-btn">
                <i class="fas fa-home"></i>
                å›åˆ°é¦–é¡µ
            </a>
            <h1>èŠå¤©æˆªå›¾ç”Ÿæˆå™¨</h1>
            <p>å®æ—¶é¢„è§ˆ Â· å³æ—¶ç”Ÿæˆ Â· å®Œç¾å‘ˆç°</p>
        </div>
        
        <div class="main-content">
            <div class="top-section">
                <div class="left-panel">
                    <div class="input-label">é€‰æ‹©æ´—ç²‰å¹³å°</div>
                    <select id="platformSelect" class="region-select">
                        <option value="dy" selected>æŠ–éŸ³ç²‰</option>
                        <option value="sph">è§†é¢‘å·ç²‰</option>
                        <option value="xhs">å°çº¢ä¹¦ç²‰</option>
                    </select>
                    
                    <div class="input-label" style="margin-top: 20px;">
                        é€‰æ‹©çº¿è·¯
                        <a href="/route/manage" class="config-link" target="_blank">é…ç½®çº¿è·¯</a>
                    </div>
                    <select id="regionSelect" class="region-select">
                        <option th:each="route, iterStat : ${routes}" 
                                th:value="${route.routeValue}" 
                                th:text="${route.routeName}"
                                th:selected="${iterStat.first}">
                        </option>
                    </select>
                    
                    <div class="input-label" style="margin-top: 20px;">
                        è¾“å…¥èŠå¤©å†…å®¹
                        <a href="#" id="rulesHelpLink" class="config-link">è¾“å…¥è§„åˆ™è¯´æ˜</a>
                        <button id="clearInputBtn" class="clear-input-btn" title="æ¸…ç©ºæ‰€æœ‰è¾“å…¥å†…å®¹">
                            ğŸ—‘ï¸ æ¸…ç©º
                        </button>
                    </div>
                    <div class="content-rules">
                        <p><strong>å†…å®¹è§„åˆ™è¯´æ˜ï¼š</strong></p>
                        <p>1ã€ç¬¬ä¸€è¡Œçš„å†…å®¹è¡¨ç¤ºä¸ºç”¨æˆ·çš„åç§°ï¼Œåœ¨å†…å®¹åé¢æ·»åŠ "11"ç»“å°¾</p>
                        <p>2ã€ä»ç¬¬äºŒè¡Œå¼€å§‹ä¸ºåŒæ–¹çš„èŠå¤©å†…å®¹ï¼Œé»˜è®¤ä¸ºç”¨æˆ·å‘é€çš„èŠå¤©å†…å®¹</p>
                        <p>3ã€ç”±æˆ‘å›å¤çš„èŠå¤©å†…å®¹æ·»åŠ "22"ç»“å°¾</p>
                    </div>
                    
                    <!-- æ–°çš„æ–‡æœ¬è¾“å…¥åŒºåŸŸï¼Œæ”¯æŒè¡Œçº§åˆ é™¤å’Œå¤šè¡Œé€‰æ‹© -->
                    <div id="chatInputContainer" class="text-input-container">
                        <div id="chatInputLines" class="text-input-lines">
                            <!-- é€‰æ‹©æŒ‡ç¤ºå™¨ -->
                            <div id="selectionIndicator" class="selection-indicator"></div>
                            
                            <!-- åˆå§‹ç©ºè¡Œ -->
                            <div class="input-line" data-line="0">
                                <div class="line-content" contenteditable="true" data-placeholder="è¯·è¾“å…¥èŠå¤©å†…å®¹..."></div>
                                <button class="delete-line-btn" title="åˆ é™¤æ­¤è¡Œ">Ã—</button>
                            </div>
                        </div>
                        
                        <!-- é€‰æ‹©å·¥å…·æ  -->
                        <div id="selectionToolbar" class="selection-toolbar">
                            <button class="copy-selected" title="å¤åˆ¶é€‰ä¸­å†…å®¹">ğŸ“‹ å¤åˆ¶</button>
                            <button class="delete-selected" title="åˆ é™¤é€‰ä¸­è¡Œ">ğŸ—‘ï¸ åˆ é™¤</button>
                            <button class="clear-selection" title="æ¸…é™¤é€‰æ‹©">âœ–ï¸ æ¸…é™¤</button>
                        </div>
                        <!-- æ‰¹é‡åˆ é™¤å·¥å…·æ  -->
                        <div id="batchDeleteToolbar" class="batch-delete-toolbar">
                            <button class="batch-delete-enter" title="è¿›å…¥æ‰¹é‡åˆ é™¤æ¨¡å¼">æ‰¹é‡åˆ é™¤</button>
                            <button class="batch-delete-confirm" title="ç¡®è®¤åˆ é™¤é€‰ä¸­é¡¹" style="display: none;">åˆ é™¤é€‰ä¸­</button>
                            <button class="batch-delete-cancel" title="å–æ¶ˆæ‰¹é‡åˆ é™¤" style="display: none;">å–æ¶ˆ</button>
                            <button id="clearAllBtn" class="clear-all-btn" title="æ¸…ç©ºæ‰€æœ‰å†…å®¹">ğŸ—‘ï¸ æ¸…ç©º</button>
                        </div>
                        
                        <div class="add-line-btn-container">
                            <button id="addLineBtn" class="add-line-btn" title="æ·»åŠ æ–°è¡Œ">+ æ·»åŠ æ–°è¡Œ</button>
                        </div>
                    </div>
                    
                    <!-- éšè—çš„textareaç”¨äºå…¼å®¹ç°æœ‰åŠŸèƒ½ -->
                    <textarea 
                        id="chatInput" 
                        class="text-input" 
                        rows="10"
                        style="display: none;"
                    ></textarea>
                    
                    <!-- å›¾ç‰‡ç²˜è´´åŒºåŸŸ -->
                    <div class="image-paste-section">
                        <div class="input-label" style="margin-top: 15px; margin-bottom: 10px;">
                            ğŸ“· å›¾ç‰‡æ–‡å­—è¯†åˆ«
                            <span class="ocr-hint">ï¼ˆæ”¯æŒCtrl+Vç²˜è´´å›¾ç‰‡è¿›è¡Œæ–‡å­—è¯†åˆ«ï¼‰</span>
                        </div>
                        <div id="imagePasteArea" class="image-paste-area">
                            <!-- éšè—çš„æ–‡ä»¶è¾“å…¥å…ƒç´  -->
                            <input type="file" id="fileInput" accept="image/*" style="display: none;">
                            <div class="paste-placeholder">
                                <div class="paste-icon">ğŸ“‹</div>
                                <div class="paste-text">ç‚¹å‡»ä¸Šä¼ å›¾ç‰‡æˆ–æŒ‰ Ctrl+V ç²˜è´´</div>
                                <div class="paste-subtext">æ”¯æŒæ‹–æ‹½ã€ç²˜è´´ã€ç‚¹å‡»ä¸Šä¼ ï¼Œè‡ªåŠ¨è¯†åˆ«å›¾ç‰‡ä¸­çš„æ–‡å­—</div>
                            </div>
                            <div id="imagePreview" class="image-preview" style="display: none;">
                                <img id="previewImg" src="" alt="é¢„è§ˆå›¾ç‰‡">
                                <div class="image-actions">
                                    <button id="ocrBtn" class="ocr-btn">ğŸ” è¯†åˆ«æ–‡å­—</button>
                                    <button id="clearBtn" class="clear-btn">ğŸ—‘ï¸ æ¸…é™¤</button>
                                </div>
                            </div>
                            <div id="ocrResult" class="ocr-result" style="display: none;">
                                <div class="ocr-status">
                                    <span id="ocrStatusText">æ­£åœ¨è¯†åˆ«ä¸­...</span>
                                    <div class="loading-spinner"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="char-counter">
                        <span id="charCount">0</span> å­—ç¬¦
                    </div>
                </div>
                
                <div class="right-panel">
                    <div class="preview-label">æ‰‹æœºé¢„è§ˆ</div>
                    <div class="phone-container">
                        <iframe 
                            id="previewFrame" 
                            class="phone-iframe" 
                            src="/generateDyChat"
                            title="æ‰‹æœºé¢„è§ˆ">
                        </iframe>
                    </div>
                </div>
            </div>
            
        </div>
    </div>

    <!-- å›ºå®šå®šä½çš„ç”ŸæˆæŒ‰é’® -->
    <button id="generateBtn" class="generate-btn">
        ğŸ¨ ç”ŸæˆèŠå¤©æˆªå›¾
    </button>

    <script>
        // è·å–DOMå…ƒç´ 
        const chatInput = document.getElementById('chatInput');
        const previewFrame = document.getElementById('previewFrame');
        const generateBtn = document.getElementById('generateBtn');
        const charCount = document.getElementById('charCount');
        const regionSelect = document.getElementById('regionSelect');
        const platformSelect = document.getElementById('platformSelect');
        
        // æ¨¡æ€å¼¹çª—ç›¸å…³å…ƒç´ 
        const rulesHelpLink = document.getElementById('rulesHelpLink');
        const rulesModal = document.getElementById('rulesModal');
        const closeModal = document.getElementById('closeModal');
        
        // å›¾ç‰‡ç²˜è´´ç›¸å…³å…ƒç´ 
        const imagePasteArea = document.getElementById('imagePasteArea');
        const fileInput = document.getElementById('fileInput');
        const imagePreview = document.getElementById('imagePreview');
        const previewImg = document.getElementById('previewImg');
        const ocrBtn = document.getElementById('ocrBtn');
        const clearBtn = document.getElementById('clearBtn');
        const ocrResult = document.getElementById('ocrResult');
        const ocrStatusText = document.getElementById('ocrStatusText');
        
        // æ–°çš„æ–‡æœ¬è¾“å…¥ç»„ä»¶ç›¸å…³å…ƒç´ 
        const chatInputContainer = document.getElementById('chatInputContainer');
        const chatInputLines = document.getElementById('chatInputLines');
        const addLineBtn = document.getElementById('addLineBtn');
        
        // å½“å‰ç²˜è´´çš„å›¾ç‰‡æ•°æ®
        let currentImageData = null;
        
        // è¡Œè®¡æ•°å™¨
        let lineCounter = 0;

        // è¡Œçº§åˆ é™¤åŠŸèƒ½
        class LineEditor {
            constructor() {
                this.initializeEvents();
                this.syncWithOriginalTextarea();
                this.initializeMultiLineSelection();
                this.initializeBatchDelete();
                this.initializeUndo();
                this.initializeClearInputButton();
            }

            initializeEvents() {
                // æ·»åŠ æ–°è¡ŒæŒ‰é’®äº‹ä»¶
                addLineBtn.addEventListener('click', () => {
                    this.addNewLine();
                });

                // å§”æ‰˜äº‹ä»¶å¤„ç†æŒ‰é’®ç‚¹å‡»
                chatInputLines.addEventListener('click', (e) => {
                    if (e.target.classList.contains('delete-line-btn')) {
                        // å¦‚æœåœ¨æ‰¹é‡åˆ é™¤æ¨¡å¼ä¸‹ï¼Œåˆ‡æ¢é€‰æ‹©çŠ¶æ€
                        if (this.batchDeleteMode) {
                            this.toggleBatchSelectButton(e.target);
                        } else {
                            // æ™®é€šåˆ é™¤æ¨¡å¼
                            this.deleteLine(e.target.closest('.input-line'));
                        }
                    } else if (e.target.classList.contains('insert-above-btn')) {
                        const currentLine = e.target.closest('.input-line');
                        if (currentLine) {
                            this.insertLineAbove(currentLine);
                        }
                    }
                });

                // å¤„ç†Enteré”®åˆ›å»ºæ–°è¡Œ
                chatInputLines.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' && e.target.classList.contains('line-content')) {
                        // Ctrl/Cmd + Shift + Enter: åœ¨å½“å‰è¡Œä¸Šæ–¹æ’å…¥æ–°è¡Œ
                        if ((e.ctrlKey || e.metaKey) && e.shiftKey) {
                            e.preventDefault();
                            const currentLine = this.getCurrentLine();
                            if (currentLine) {
                                this.insertLineAbove(currentLine);
                            }
                        }
                        // æ™®é€šEnter: åœ¨æœ«å°¾æ·»åŠ æ–°è¡Œ
                        else {
                            e.preventDefault();
                            this.addNewLine();
                            // èšç„¦åˆ°æ–°è¡Œ
                            setTimeout(() => {
                                const lines = chatInputLines.querySelectorAll('.line-content');
                                const lastLine = lines[lines.length - 1];
                                if (lastLine) {
                                    lastLine.focus();
                                }
                            }, 10);
                        }
                    }
                });

                // å¤„ç†å†…å®¹å˜åŒ–ï¼ŒåŒæ­¥åˆ°åŸå§‹textarea
                chatInputLines.addEventListener('input', () => {
                    this.syncWithOriginalTextarea();
                });

                // å¤„ç†ç²˜è´´äº‹ä»¶
                chatInputLines.addEventListener('paste', (e) => {
                    if (e.target.classList.contains('line-content')) {
                        e.preventDefault();
                        const text = (e.clipboardData || window.clipboardData).getData('text');
                        this.insertTextAtCursor(e.target, text);
                    }
                });
            }

            addNewLine(content = '') {
                lineCounter++;
                const lineDiv = document.createElement('div');
                lineDiv.className = 'input-line';
                lineDiv.setAttribute('data-line', lineCounter);
                
                lineDiv.innerHTML = `
                    <div class="line-content" contenteditable="true" data-placeholder="è¯·è¾“å…¥å†…å®¹...">${content}</div>
                    <div class="line-actions">
                        <button class="insert-above-btn" title="åœ¨ä¸Šæ–¹æ’å…¥æ–°è¡Œ">â†‘</button>
                        <button class="delete-line-btn" title="åˆ é™¤æ­¤è¡Œ">Ã—</button>
                    </div>
                `;
                
                chatInputLines.appendChild(lineDiv);
                this.syncWithOriginalTextarea();
                return lineDiv;
            }

            // åœ¨æŒ‡å®šè¡Œçš„ä¸Šæ–¹æ’å…¥æ–°è¡Œ
            insertLineAbove(targetLine, content = '') {
                lineCounter++;
                const lineDiv = document.createElement('div');
                lineDiv.className = 'input-line';
                lineDiv.setAttribute('data-line', lineCounter);
                
                lineDiv.innerHTML = `
                    <div class="line-content" contenteditable="true" data-placeholder="è¯·è¾“å…¥å†…å®¹...">${content}</div>
                    <div class="line-actions">
                        <button class="insert-above-btn" title="åœ¨ä¸Šæ–¹æ’å…¥æ–°è¡Œ">â†‘</button>
                        <button class="delete-line-btn" title="åˆ é™¤æ­¤è¡Œ">Ã—</button>
                    </div>
                `;
                
                // åœ¨ç›®æ ‡è¡Œä¹‹å‰æ’å…¥æ–°è¡Œ
                chatInputLines.insertBefore(lineDiv, targetLine);
                this.syncWithOriginalTextarea();
                
                // èšç„¦åˆ°æ–°æ’å…¥çš„è¡Œ
                const newLineContent = lineDiv.querySelector('.line-content');
                if (newLineContent) {
                    newLineContent.focus();
                }
                
                return lineDiv;
            }

            // è·å–å½“å‰å…‰æ ‡æ‰€åœ¨çš„è¡Œå…ƒç´ 
            getCurrentLine() {
                const selection = window.getSelection();
                if (selection.rangeCount > 0) {
                    const range = selection.getRangeAt(0);
                    let node = range.startContainer;
                    
                    // å‘ä¸ŠæŸ¥æ‰¾ç›´åˆ°æ‰¾åˆ°.input-lineå…ƒç´ 
                    while (node && node.nodeType !== Node.ELEMENT_NODE || !node.classList?.contains('input-line')) {
                        node = node.parentNode;
                        if (!node || node === chatInputLines) {
                            break;
                        }
                    }
                    
                    return node && node.classList?.contains('input-line') ? node : null;
                }
                return null;
            }



            insertTextAtCursor(element, text) {
                const selection = window.getSelection();
                const range = selection.getRangeAt(0);
                range.deleteContents();
                
                const lines = text.split('\n');
                if (lines.length === 1) {
                    // å•è¡Œæ–‡æœ¬ï¼Œç›´æ¥æ’å…¥
                    const textNode = document.createTextNode(text);
                    range.insertNode(textNode);
                    range.setStartAfter(textNode);
                    range.setEndAfter(textNode);
                } else {
                    // å¤šè¡Œæ–‡æœ¬ï¼Œéœ€è¦åˆ›å»ºæ–°è¡Œ
                    const firstLine = lines[0];
                    if (firstLine) {
                        const textNode = document.createTextNode(firstLine);
                        range.insertNode(textNode);
                    }
                    
                    // ä¸ºå‰©ä½™è¡Œåˆ›å»ºæ–°çš„è¡Œå…ƒç´ 
                    for (let i = 1; i < lines.length; i++) {
                        this.addNewLine(lines[i]);
                    }
                }
                
                selection.removeAllRanges();
                selection.addRange(range);
                this.syncWithOriginalTextarea();
            }

            syncWithOriginalTextarea() {
                const lines = chatInputLines.querySelectorAll('.line-content');
                const content = Array.from(lines).map(line => line.textContent || '').join('\n');
                chatInput.value = content;
                
                // è§¦å‘åŸå§‹textareaçš„inputäº‹ä»¶ä»¥ä¿æŒå…¼å®¹æ€§
                const event = new Event('input', { bubbles: true });
                chatInput.dispatchEvent(event);
            }

            // ä»åŸå§‹textareaåŠ è½½å†…å®¹
            loadFromTextarea() {
                const content = chatInput.value;
                if (content.trim()) {
                    // æ¸…ç©ºç°æœ‰è¡Œ
                    chatInputLines.innerHTML = '';
                    lineCounter = 0;
                    
                    // æŒ‰è¡Œåˆ†å‰²å¹¶åˆ›å»ºè¡Œå…ƒç´ 
                    const lines = content.split('\n');
                    lines.forEach(line => {
                        this.addNewLine(line);
                    });
                } else {
                    // ç¡®ä¿è‡³å°‘æœ‰ä¸€ä¸ªç©ºè¡Œ
                    if (chatInputLines.children.length === 0) {
                        this.addNewLine();
                    }
                }
            }

            // å¤šè¡Œé€‰æ‹©åŠŸèƒ½
            initializeMultiLineSelection() {
                this.isSelecting = false;
                this.selectedLines = new Set();
                this.startLine = null;
                this.currentFocusLine = null; // å½“å‰é”®ç›˜ç„¦ç‚¹è¡Œ
                this.selectionIndicator = document.querySelector('.selection-indicator');
                this.selectionToolbar = document.querySelector('.selection-toolbar');
                
                // ç»‘å®šé¼ æ ‡äº‹ä»¶
                chatInputLines.addEventListener('mousedown', (e) => this.handleMouseDown(e));
                document.addEventListener('mousemove', (e) => this.handleMouseMove(e));
                document.addEventListener('mouseup', (e) => this.handleMouseUp(e));
                
                // ç»‘å®šå·¥å…·æ æŒ‰é’®äº‹ä»¶
                const copyBtn = this.selectionToolbar.querySelector('.copy-selected');
                const deleteBtn = this.selectionToolbar.querySelector('.delete-selected');
                const clearBtn = this.selectionToolbar.querySelector('.clear-selection');
                
                copyBtn.addEventListener('click', () => this.copySelectedLines());
                deleteBtn.addEventListener('click', () => this.deleteSelectedLines());
                clearBtn.addEventListener('click', () => this.clearSelection());
                
                // é˜»æ­¢é»˜è®¤çš„æ–‡æœ¬é€‰æ‹©
                chatInputLines.addEventListener('selectstart', (e) => {
                    if (this.isSelecting) {
                        e.preventDefault();
                    }
                });
                
                // æ·»åŠ å¿«æ·é”®æ”¯æŒ
                document.addEventListener('keydown', (e) => this.handleKeyDown(e));
            }

            handleMouseDown(e) {
                // æ£€æŸ¥æ˜¯å¦ç‚¹å‡»åœ¨è¡Œå†…å®¹ä¸Š
                const lineContent = e.target.closest('.line-content');
                if (!lineContent) return;
                
                const inputLine = lineContent.closest('.input-line');
                if (!inputLine) return;
                
                // å¦‚æœç‚¹å‡»çš„æ˜¯æŒ‰é’®ï¼Œä¸å¯åŠ¨é€‰æ‹©
                if (e.target.closest('.delete-line-btn') || e.target.closest('.insert-above-btn')) {
                    return;
                }
                
                // è®°å½•é¼ æ ‡æŒ‰ä¸‹çš„ä½ç½®å’Œæ—¶é—´ï¼Œç”¨äºåŒºåˆ†ç‚¹å‡»å’Œæ‹–åŠ¨
                this.mouseDownTime = Date.now();
                this.mouseDownX = e.clientX;
                this.mouseDownY = e.clientY;
                this.potentialStartLine = inputLine;
                
                // ä¸ç«‹å³é˜»æ­¢é»˜è®¤è¡Œä¸ºï¼Œè®©æµè§ˆå™¨å¤„ç†æ–‡å­—é€‰æ‹©
                // åªæœ‰åœ¨ç¡®å®šæ˜¯è¡Œé€‰æ‹©æ“ä½œæ—¶æ‰é˜»æ­¢é»˜è®¤è¡Œä¸º
            }

            handleMouseMove(e) {
                // å¦‚æœæ²¡æœ‰è®°å½•é¼ æ ‡æŒ‰ä¸‹ä¿¡æ¯ï¼Œç›´æ¥è¿”å›
                if (!this.potentialStartLine) return;
                
                // è®¡ç®—é¼ æ ‡ç§»åŠ¨è·ç¦»
                const deltaX = Math.abs(e.clientX - this.mouseDownX);
                const deltaY = Math.abs(e.clientY - this.mouseDownY);
                const moveDistance = Math.sqrt(deltaX * deltaX + deltaY * deltaY);
                
                // å¦‚æœç§»åŠ¨è·ç¦»å¾ˆå°ï¼Œå¯èƒ½æ˜¯æ–‡å­—é€‰æ‹©ï¼Œä¸å¯åŠ¨è¡Œé€‰æ‹©
                if (moveDistance < 10) return;
                
                // å¦‚æœè¿˜æ²¡æœ‰å¯åŠ¨è¡Œé€‰æ‹©ï¼Œç°åœ¨å¯åŠ¨
                if (!this.isSelecting) {
                    this.isSelecting = true;
                    this.startLine = this.potentialStartLine;
                    this.clearSelection();
                    this.selectLine(this.startLine, false); // ä¸è®¾ç½®ç„¦ç‚¹ï¼Œé¿å…å¹²æ‰°æ–‡å­—é€‰æ‹©
                }
                
                const lineContent = e.target.closest('.line-content');
                if (!lineContent) return;
                
                const currentLine = lineContent.closest('.input-line');
                if (!currentLine) return;
                
                // æ¸…é™¤å½“å‰é€‰æ‹©
                this.clearSelection();
                
                // é€‰æ‹©ä»å¼€å§‹è¡Œåˆ°å½“å‰è¡Œçš„æ‰€æœ‰è¡Œ
                const allLines = Array.from(chatInputLines.querySelectorAll('.input-line'));
                const startIndex = allLines.indexOf(this.startLine);
                const currentIndex = allLines.indexOf(currentLine);
                
                const minIndex = Math.min(startIndex, currentIndex);
                const maxIndex = Math.max(startIndex, currentIndex);
                
                for (let i = minIndex; i <= maxIndex; i++) {
                    // åªæœ‰æœ€åä¸€è¡Œæ‰è®¾ç½®ç„¦ç‚¹
                    const shouldFocus = (i === maxIndex);
                    this.selectLine(allLines[i], shouldFocus);
                }
                
                this.updateSelectionIndicator();
            }

            handleMouseUp(e) {
                // è®¡ç®—é¼ æ ‡æŒ‰ä¸‹åˆ°æŠ¬èµ·çš„æ—¶é—´å’Œè·ç¦»
                const clickDuration = Date.now() - (this.mouseDownTime || 0);
                const deltaX = Math.abs(e.clientX - (this.mouseDownX || 0));
                const deltaY = Math.abs(e.clientY - (this.mouseDownY || 0));
                const moveDistance = Math.sqrt(deltaX * deltaX + deltaY * deltaY);
                
                // å¦‚æœæ˜¯ç®€å•ç‚¹å‡»ï¼ˆæ—¶é—´çŸ­ä¸”ç§»åŠ¨è·ç¦»å°ï¼‰
                if (clickDuration < 300 && moveDistance < 10 && this.potentialStartLine && !this.isSelecting) {
                    // ä½¿ç”¨å•è¡Œé€‰æ‹©æ–¹æ³•ï¼Œç¡®ä¿åªé€‰ä¸­ä¸€è¡Œ
                    this.selectSingleLine(this.potentialStartLine, true, e);
                }
                
                // é‡ç½®çŠ¶æ€
                if (this.isSelecting) {
                    this.isSelecting = false;
                    
                    // å¦‚æœæœ‰é€‰ä¸­çš„è¡Œï¼Œæ˜¾ç¤ºå·¥å…·æ 
                    if (this.selectedLines.size > 0) {
                        this.showSelectionToolbar();
                    }
                }
                
                // æ¸…é™¤é¼ æ ‡æŒ‰ä¸‹è®°å½•
                this.potentialStartLine = null;
                this.mouseDownTime = null;
                this.mouseDownX = null;
                this.mouseDownY = null;
            }

            // å°†å…‰æ ‡å®šä½åˆ°æŒ‡å®šè¡Œçš„å†…å®¹åŒºåŸŸçš„æŒ‡å®šä½ç½®
            focusOnLine(lineContent, clickEvent = null) {
                if (!lineContent) return;
                
                // è®¾ç½®ç„¦ç‚¹åˆ°è¡Œå†…å®¹
                lineContent.focus();
                
                // å¦‚æœæœ‰ç‚¹å‡»äº‹ä»¶ï¼Œè®©æµè§ˆå™¨è‡ªç„¶å¤„ç†å…‰æ ‡å®šä½
                if (clickEvent) {
                    // ä¸å¹²é¢„æµè§ˆå™¨çš„è‡ªç„¶å…‰æ ‡å®šä½ï¼Œè®©ç”¨æˆ·ç‚¹å‡»å“ªé‡Œå…‰æ ‡å°±åœ¨å“ªé‡Œ
                    return;
                }
                
                // å¦‚æœæ²¡æœ‰ç‚¹å‡»äº‹ä»¶ï¼ˆæ¯”å¦‚ç¨‹åºåŒ–è°ƒç”¨ï¼‰ï¼Œåˆ™å®šä½åˆ°è¡Œæœ«å°¾
                const range = document.createRange();
                const selection = window.getSelection();
                
                // å¦‚æœè¡Œå†…å®¹ä¸ºç©ºï¼Œç›´æ¥è®¾ç½®ç„¦ç‚¹
                if (lineContent.textContent.length === 0) {
                    range.setStart(lineContent, 0);
                    range.collapse(true);
                } else {
                    // å¦‚æœè¡Œå†…å®¹ä¸ä¸ºç©ºï¼Œå°†å…‰æ ‡å®šä½åˆ°è¡Œæœ«å°¾
                    const lastChild = lineContent.lastChild;
                    if (lastChild && lastChild.nodeType === Node.TEXT_NODE) {
                        // å¦‚æœæœ€åä¸€ä¸ªå­èŠ‚ç‚¹æ˜¯æ–‡æœ¬èŠ‚ç‚¹ï¼Œå®šä½åˆ°æ–‡æœ¬æœ«å°¾
                        range.setStart(lastChild, lastChild.textContent.length);
                    } else {
                        // å¦åˆ™å®šä½åˆ°å…ƒç´ æœ«å°¾
                        range.setStart(lineContent, lineContent.childNodes.length);
                    }
                    range.collapse(true);
                }
                
                selection.removeAllRanges();
                selection.addRange(range);
            }

            selectLine(line, shouldFocus = true, clickEvent = null) {
                if (!line) return;
                
                line.classList.add('selected');
                this.selectedLines.add(line);
                
                const lineContent = line.querySelector('.line-content');
                if (lineContent) {
                    lineContent.classList.add('selecting');
                    
                    // åªæœ‰åœ¨shouldFocusä¸ºtrueæ—¶æ‰è‡ªåŠ¨å°†å…‰æ ‡å®šä½åˆ°è¯¥è¡Œ
                    if (shouldFocus) {
                        this.focusOnLine(lineContent, clickEvent);
                    }
                }
            }

            // å•è¡Œé€‰æ‹©æ–¹æ³• - ç¡®ä¿åªé€‰ä¸­ä¸€è¡Œï¼Œå…¶ä»–è¡Œè‡ªåŠ¨å–æ¶ˆé€‰ä¸­
            selectSingleLine(line, shouldFocus = true, clickEvent = null) {
                if (!line) return;
                
                // å…ˆæ¸…é™¤æ‰€æœ‰é€‰ä¸­çŠ¶æ€ï¼ˆåŒ…æ‹¬è§†è§‰æ ·å¼ï¼‰
                this.clearAllSelections();
                
                // æ¸…é™¤é”®ç›˜ç„¦ç‚¹æ ·å¼
                if (this.currentFocusLine && this.currentFocusLine !== line) {
                    this.currentFocusLine.classList.remove('keyboard-focus');
                }
                
                // è®¾ç½®æ–°çš„é”®ç›˜ç„¦ç‚¹
                this.currentFocusLine = line;
                
                // é€‰ä¸­æ–°è¡Œ
                line.classList.add('selected');
                this.selectedLines.add(line);
                
                const lineContent = line.querySelector('.line-content');
                if (lineContent) {
                    lineContent.classList.add('selecting');
                    
                    // åªæœ‰åœ¨shouldFocusä¸ºtrueæ—¶æ‰è‡ªåŠ¨å°†å…‰æ ‡å®šä½åˆ°è¯¥è¡Œ
                    if (shouldFocus) {
                        this.focusOnLine(lineContent, clickEvent);
                    }
                }
                
                // æ›´æ–°é€‰æ‹©æŒ‡ç¤ºå™¨
                this.updateSelectionIndicator();
            }

            // æ¸…é™¤æ‰€æœ‰é€‰æ‹©çŠ¶æ€ï¼ˆä¸å½±å“é”®ç›˜ç„¦ç‚¹ï¼‰
            clearAllSelections() {
                // æ¸…é™¤æ‰€æœ‰é€‰ä¸­çŠ¶æ€
                this.selectedLines.forEach(line => {
                    line.classList.remove('selected');
                    const lineContent = line.querySelector('.line-content');
                    if (lineContent) {
                        lineContent.classList.remove('selecting');
                    }
                });
                
                this.selectedLines.clear();
                this.hideSelectionIndicator();
                this.hideSelectionToolbar();
            }

            clearSelection() {
                // æ¸…é™¤æ‰€æœ‰é€‰ä¸­çŠ¶æ€
                this.selectedLines.forEach(line => {
                    line.classList.remove('selected');
                    const lineContent = line.querySelector('.line-content');
                    if (lineContent) {
                        lineContent.classList.remove('selecting');
                    }
                });
                
                // æ¸…é™¤é”®ç›˜ç„¦ç‚¹çŠ¶æ€ï¼ˆä½†ä¸é‡ç½®currentFocusLineï¼Œä¿æŒé”®ç›˜å¯¼èˆªçŠ¶æ€ï¼‰
                const allLines = chatInputLines.querySelectorAll('.input-line');
                allLines.forEach(line => {
                    line.classList.remove('keyboard-focus');
                });
                
                this.selectedLines.clear();
                this.hideSelectionIndicator();
                this.hideSelectionToolbar();
            }

            updateSelectionIndicator() {
                if (this.selectedLines.size === 0) {
                    this.hideSelectionIndicator();
                    return;
                }
                
                const lines = Array.from(this.selectedLines);
                const firstLine = lines[0];
                const lastLine = lines[lines.length - 1];
                
                const containerRect = chatInputLines.getBoundingClientRect();
                const firstRect = firstLine.getBoundingClientRect();
                const lastRect = lastLine.getBoundingClientRect();
                
                this.selectionIndicator.style.top = (firstRect.top - containerRect.top) + 'px';
                this.selectionIndicator.style.height = (lastRect.bottom - firstRect.top) + 'px';
                this.selectionIndicator.style.display = 'block';
            }

            hideSelectionIndicator() {
                this.selectionIndicator.style.display = 'none';
            }

            showSelectionToolbar() {
                if (this.selectedLines.size === 0) return;
                
                this.selectionToolbar.style.display = 'flex';
                
                // æ›´æ–°æŒ‰é’®æ–‡æœ¬
                const copyBtn = this.selectionToolbar.querySelector('.copy-selected');
                const deleteBtn = this.selectionToolbar.querySelector('.delete-selected');
                
                copyBtn.textContent = `å¤åˆ¶ ${this.selectedLines.size} è¡Œ`;
                deleteBtn.textContent = `åˆ é™¤ ${this.selectedLines.size} è¡Œ`;
            }

            hideSelectionToolbar() {
                this.selectionToolbar.style.display = 'none';
            }

            copySelectedLines() {
                if (this.selectedLines.size === 0) return;
                
                const lines = Array.from(this.selectedLines);
                const content = lines.map(line => {
                    const lineContent = line.querySelector('.line-content');
                    return lineContent ? lineContent.textContent || '' : '';
                }).join('\n');
                
                // å¤åˆ¶åˆ°å‰ªè´´æ¿
                navigator.clipboard.writeText(content).then(() => {
                    this.showToast('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success');
                }).catch(() => {
                    // é™çº§æ–¹æ¡ˆ
                    const textArea = document.createElement('textarea');
                    textArea.value = content;
                    document.body.appendChild(textArea);
                    textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);
                    this.showToast('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success');
                });
                
                this.clearSelection();
            }

            deleteSelectedLines() {
                if (this.selectedLines.size === 0) return;
                
                const selectedCount = this.selectedLines.size;
                const lines = Array.from(this.selectedLines);
                const allLines = Array.from(chatInputLines.querySelectorAll('.input-line'));
                
                // è·å–ç¬¬ä¸€ä¸ªè¢«åˆ é™¤è¡Œçš„ç´¢å¼•ï¼Œç”¨äºåç»­å…‰æ ‡å®šä½
                const firstDeletedIndex = Math.min(...lines.map(line => allLines.indexOf(line)));
                const totalLinesBeforeDelete = allLines.length;
                
                // ä¿å­˜æ’¤é”€çŠ¶æ€
                const deletedLines = lines.map(line => line.cloneNode(true));
                const insertPositions = lines.map(line => allLines.indexOf(line));
                
                this.saveUndoState('delete_lines', {
                    deletedLines: deletedLines,
                    insertPositions: insertPositions
                });
                
                // åˆ é™¤é€‰ä¸­çš„è¡Œ
                lines.forEach(line => {
                    line.remove();
                });
                
                // å¦‚æœæ²¡æœ‰è¡Œäº†ï¼Œæ·»åŠ ä¸€ä¸ªç©ºè¡Œ
                if (chatInputLines.children.length === 0) {
                    this.addNewLine();
                } else {
                    // å¤„ç†åˆ é™¤åçš„å…‰æ ‡å®šä½å’Œé€‰ä¸­
                    this.handlePostDeleteFocus(firstDeletedIndex, totalLinesBeforeDelete);
                }
                
                this.syncWithOriginalTextarea();
                this.showUndoNotification(`å·²åˆ é™¤ ${selectedCount} è¡Œ`);
            }

            handleKeyDown(e) {
                // ä¸Šä¸‹æ–¹å‘é”®é€‰ä¸­è¡ŒåŠŸèƒ½
                if (e.key === 'ArrowUp' || e.key === 'ArrowDown') {
                    // åªæœ‰åœ¨æ–‡æœ¬è¾“å…¥åŒºåŸŸå†…æ‰å¤„ç†æ–¹å‘é”®
                    if (e.target.closest('.text-input-lines')) {
                        // æ£€æŸ¥æ˜¯å¦åº”è¯¥è§¦å‘è¡Œå¯¼èˆª
                        if (this.shouldTriggerLineNavigation(e)) {
                            e.preventDefault();
                            this.handleArrowKeyNavigation(e.key);
                            return;
                        }
                    }
                }
                
                // Deleteé”®åˆ é™¤é€»è¾‘
                if (e.key === 'Delete') {
                    // å¦‚æœæœ‰é€‰ä¸­çš„è¡Œï¼Œåˆ é™¤é€‰ä¸­çš„è¡Œ
                    if (this.selectedLines.size > 0) {
                        // æ£€æŸ¥æ˜¯å¦åœ¨è¾“å…¥æ¡†å†…ç¼–è¾‘æ–‡æœ¬
                        const activeElement = document.activeElement;
                        if (activeElement && activeElement.classList.contains('line-content') && 
                            !this.selectedLines.has(activeElement.closest('.input-line'))) {
                            return; // å¦‚æœåœ¨ç¼–è¾‘éé€‰ä¸­è¡Œçš„æ–‡æœ¬ï¼Œä¸è§¦å‘åˆ é™¤
                        }
                        
                        e.preventDefault();
                        this.deleteSelectedLines();
                    } else {
                        // å¦‚æœæ²¡æœ‰é€‰ä¸­è¡Œï¼Œåˆ é™¤å½“å‰å…‰æ ‡æ‰€åœ¨çš„è¡Œ
                        const activeElement = document.activeElement;
                        if (activeElement && activeElement.classList.contains('line-content')) {
                            const currentLine = activeElement.closest('.input-line');
                            if (currentLine) {
                                // æ£€æŸ¥æ˜¯å¦ä¸ºç©ºè¡Œæˆ–å…‰æ ‡åœ¨è¡Œé¦–
                                const content = activeElement.textContent || '';
                                const selection = window.getSelection();
                                const cursorAtStart = selection.rangeCount > 0 && selection.getRangeAt(0).startOffset === 0;
                                
                                if (content.trim() === '' || cursorAtStart) {
                                    e.preventDefault();
                                    this.deleteLine(currentLine);
                                }
                            }
                        }
                    }
                }
                
                // Backspaceé”®åˆ é™¤é€‰ä¸­çš„è¡Œ
                if (e.key === 'Backspace' && this.selectedLines.size > 0) {
                    // æ£€æŸ¥æ˜¯å¦åœ¨è¾“å…¥æ¡†å†…ç¼–è¾‘æ–‡æœ¬
                    const activeElement = document.activeElement;
                    if (activeElement && activeElement.classList.contains('line-content') && 
                        !this.selectedLines.has(activeElement.closest('.input-line'))) {
                        return; // å¦‚æœåœ¨ç¼–è¾‘éé€‰ä¸­è¡Œçš„æ–‡æœ¬ï¼Œä¸è§¦å‘åˆ é™¤
                    }
                    
                    e.preventDefault();
                    this.deleteSelectedLines();
                }
                
                // Ctrl/Cmd + A å…¨é€‰æ‰€æœ‰è¡Œ
                if ((e.ctrlKey || e.metaKey) && e.key === 'a' && e.target.closest('.text-input-lines')) {
                    e.preventDefault();
                    this.selectAllLines();
                }
                
                // Escapeé”®æ¸…é™¤é€‰æ‹©
                if (e.key === 'Escape' && this.selectedLines.size > 0) {
                    e.preventDefault();
                    this.clearSelection();
                }
            }

            selectAllLines() {
                this.clearSelection();
                const allLines = chatInputLines.querySelectorAll('.input-line');
                allLines.forEach(line => this.selectLine(line));
                this.updateSelectionIndicator();
                this.showSelectionToolbar();
                this.showToast(`å·²é€‰æ‹© ${allLines.length} è¡Œ`, 'info');
            }

            showToast(message, type = 'info') {
                // åˆ›å»ºç®€å•çš„æç¤º
                const toast = document.createElement('div');
                toast.className = `selection-toast ${type}`;
                toast.textContent = message;
                toast.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: ${type === 'success' ? '#4CAF50' : type === 'warning' ? '#FF9800' : '#2196F3'};
                    color: white;
                    padding: 10px 15px;
                    border-radius: 4px;
                    z-index: 10000;
                    font-size: 14px;
                    box-shadow: 0 2px 8px rgba(0,0,0,0.2);
                `;
                
                document.body.appendChild(toast);
                
                setTimeout(() => {
                    toast.remove();
                }, 2000);
            }

            // å¤„ç†æ–¹å‘é”®å¯¼èˆª
            handleArrowKeyNavigation(key) {
                const allLines = Array.from(chatInputLines.querySelectorAll('.input-line'));
                if (allLines.length === 0) return;
                
                let targetIndex = 0;
                
                // å¦‚æœå½“å‰æœ‰ç„¦ç‚¹è¡Œï¼ŒåŸºäºå®ƒè®¡ç®—ç›®æ ‡è¡Œ
                if (this.currentFocusLine) {
                    const currentIndex = allLines.indexOf(this.currentFocusLine);
                    if (currentIndex !== -1) {
                        if (key === 'ArrowUp') {
                            targetIndex = Math.max(0, currentIndex - 1);
                        } else if (key === 'ArrowDown') {
                            targetIndex = Math.min(allLines.length - 1, currentIndex + 1);
                        }
                    }
                } else {
                    // å¦‚æœæ²¡æœ‰ç„¦ç‚¹è¡Œï¼Œå°è¯•ä»å½“å‰æ´»åŠ¨å…ƒç´ ç¡®å®šä½ç½®
                    const activeElement = document.activeElement;
                    if (activeElement && activeElement.classList.contains('line-content')) {
                        const currentLine = activeElement.closest('.input-line');
                        const currentIndex = allLines.indexOf(currentLine);
                        if (currentIndex !== -1) {
                            if (key === 'ArrowUp') {
                                targetIndex = Math.max(0, currentIndex - 1);
                            } else if (key === 'ArrowDown') {
                                targetIndex = Math.min(allLines.length - 1, currentIndex + 1);
                            }
                        }
                    } else {
                        // é»˜è®¤é€‰æ‹©ç¬¬ä¸€è¡Œ
                        targetIndex = 0;
                    }
                }
                
                // é€‰ä¸­ç›®æ ‡è¡Œå¹¶å°†å…‰æ ‡å®šä½åˆ°è¡Œæœ«
                const targetLine = allLines[targetIndex];
                if (targetLine) {
                    this.setKeyboardFocusLineWithCursorAtEnd(targetLine);
                }
            }

            // åˆ¤æ–­æ˜¯å¦åº”è¯¥è§¦å‘è¡Œå¯¼èˆª
            shouldTriggerLineNavigation(e) {
                const activeElement = document.activeElement;
                
                // æ£€æŸ¥æ˜¯å¦æœ‰æ–‡æœ¬é€‰æ‹©
                const selection = window.getSelection();
                if (selection.rangeCount > 0) {
                    const range = selection.getRangeAt(0);
                    if (!range.collapsed) {
                        // æœ‰æ–‡æœ¬é€‰æ‹©ï¼Œä¸è§¦å‘è¡Œå¯¼èˆª
                        return false;
                    }
                }
                
                // æ€»æ˜¯è§¦å‘è¡Œå¯¼èˆªï¼Œå®ç°æ¯æŒ‰ä¸€ä¸‹å°±ç›´æ¥ç§»åŠ¨åˆ°ä¸Šä¸€è¡Œæˆ–ä¸‹ä¸€è¡Œ
                return true;
            }
            
            // è·å–å…‰æ ‡åœ¨å½“å‰è¡Œä¸­çš„ä½ç½®
            getCursorPosition(element) {
                const selection = window.getSelection();
                if (selection.rangeCount === 0) return 0;
                
                const range = selection.getRangeAt(0);
                const preCaretRange = range.cloneRange();
                preCaretRange.selectNodeContents(element);
                preCaretRange.setEnd(range.endContainer, range.endOffset);
                return preCaretRange.toString().length;
            }

            // è®¾ç½®é”®ç›˜ç„¦ç‚¹è¡Œ
            setKeyboardFocusLine(line) {
                // æ¸…é™¤ä¹‹å‰çš„é”®ç›˜ç„¦ç‚¹æ ·å¼
                if (this.currentFocusLine) {
                    this.currentFocusLine.classList.remove('keyboard-focus');
                    this.currentFocusLine.classList.remove('selected');
                }
                
                // æ¸…é™¤æ‰€æœ‰é€‰ä¸­çŠ¶æ€
                this.selectedLines.forEach(selectedLine => {
                    selectedLine.classList.remove('selected');
                    const lineContent = selectedLine.querySelector('.line-content');
                    if (lineContent) {
                        lineContent.classList.remove('selecting');
                    }
                });
                this.selectedLines.clear();
                
                // è®¾ç½®æ–°çš„ç„¦ç‚¹è¡Œ
                this.currentFocusLine = line;
                line.classList.add('keyboard-focus');
                
                // é€‰ä¸­è¯¥è¡Œ
                this.selectLine(line, true);
                
                // æ»šåŠ¨åˆ°å¯è§åŒºåŸŸ
                line.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }

            // è®¾ç½®é”®ç›˜ç„¦ç‚¹è¡Œå¹¶å°†å…‰æ ‡å®šä½åˆ°è¡Œæœ«
            setKeyboardFocusLineWithCursorAtEnd(line) {
                // æ¸…é™¤ä¹‹å‰çš„é”®ç›˜ç„¦ç‚¹æ ·å¼
                if (this.currentFocusLine) {
                    this.currentFocusLine.classList.remove('keyboard-focus');
                    this.currentFocusLine.classList.remove('selected');
                }
                
                // æ¸…é™¤æ‰€æœ‰é€‰ä¸­çŠ¶æ€
                this.selectedLines.forEach(selectedLine => {
                    selectedLine.classList.remove('selected');
                    const lineContent = selectedLine.querySelector('.line-content');
                    if (lineContent) {
                        lineContent.classList.remove('selecting');
                    }
                });
                this.selectedLines.clear();
                
                // è®¾ç½®æ–°çš„ç„¦ç‚¹è¡Œ
                this.currentFocusLine = line;
                line.classList.add('keyboard-focus');
                
                // é€‰ä¸­è¯¥è¡Œ
                this.selectLine(line, true);
                
                // è·å–è¡Œå†…å®¹å…ƒç´ å¹¶è®¾ç½®ç„¦ç‚¹
                const lineContent = line.querySelector('.line-content');
                if (lineContent) {
                    lineContent.focus();
                    
                    // å°†å…‰æ ‡å®šä½åˆ°è¡Œæœ«
                    const textLength = lineContent.textContent.length;
                    if (textLength > 0) {
                        // åˆ›å»ºä¸€ä¸ªèŒƒå›´å¹¶è®¾ç½®åˆ°æ–‡æœ¬æœ«å°¾
                        const range = document.createRange();
                        const selection = window.getSelection();
                        
                        // å¦‚æœæœ‰æ–‡æœ¬èŠ‚ç‚¹ï¼Œå°†å…‰æ ‡è®¾ç½®åˆ°æœ€åä¸€ä¸ªæ–‡æœ¬èŠ‚ç‚¹çš„æœ«å°¾
                        const textNode = this.getLastTextNode(lineContent);
                        if (textNode) {
                            range.setStart(textNode, textNode.textContent.length);
                            range.setEnd(textNode, textNode.textContent.length);
                        } else {
                            // å¦‚æœæ²¡æœ‰æ–‡æœ¬èŠ‚ç‚¹ï¼Œè®¾ç½®åˆ°å…ƒç´ æœ«å°¾
                            range.selectNodeContents(lineContent);
                            range.collapse(false);
                        }
                        
                        selection.removeAllRanges();
                        selection.addRange(range);
                    }
                }
                
                // æ»šåŠ¨åˆ°å¯è§åŒºåŸŸ
                line.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }

            // è·å–å…ƒç´ ä¸­çš„æœ€åä¸€ä¸ªæ–‡æœ¬èŠ‚ç‚¹
            getLastTextNode(element) {
                let lastTextNode = null;
                const walker = document.createTreeWalker(
                    element,
                    NodeFilter.SHOW_TEXT,
                    null,
                    false
                );
                
                let node;
                while (node = walker.nextNode()) {
                    lastTextNode = node;
                }
                
                return lastTextNode;
            }

            // æ‰¹é‡åˆ é™¤åŠŸèƒ½
            initializeBatchDelete() {
                this.batchDeleteMode = false;
                this.batchSelectedButtons = new Set();
                this.batchDeleteToolbar = document.getElementById('batchDeleteToolbar');
                
                // ç»‘å®šæ‰¹é‡åˆ é™¤å·¥å…·æ äº‹ä»¶
                const enterBtn = this.batchDeleteToolbar.querySelector('.batch-delete-enter');
                const confirmBtn = this.batchDeleteToolbar.querySelector('.batch-delete-confirm');
                const cancelBtn = this.batchDeleteToolbar.querySelector('.batch-delete-cancel');
                const clearAllBtn = this.batchDeleteToolbar.querySelector('.clear-all-btn');
                
                enterBtn.addEventListener('click', () => this.enterBatchDeleteMode());
                confirmBtn.addEventListener('click', () => this.confirmBatchDelete());
                cancelBtn.addEventListener('click', () => this.exitBatchDeleteMode());
                clearAllBtn.addEventListener('click', () => this.clearAllContent());
                
                // åˆå§‹åŒ–ç¡®è®¤å¯¹è¯æ¡†
                this.initializeDeleteConfirmation();
                
                // æ˜¾ç¤ºæ‰¹é‡åˆ é™¤å·¥å…·æ 
                this.showBatchDeleteToolbar();
            }

            initializeDeleteConfirmation() {
                this.deleteConfirmationOverlay = document.getElementById('deleteConfirmationOverlay');
                this.deleteConfirmationMessage = document.getElementById('deleteConfirmationMessage');
                this.deleteConfirmationCancel = document.getElementById('deleteConfirmationCancel');
                this.deleteConfirmationConfirm = document.getElementById('deleteConfirmationConfirm');
                
                // ç»‘å®šç¡®è®¤å¯¹è¯æ¡†äº‹ä»¶
                this.deleteConfirmationCancel.addEventListener('click', () => this.hideDeleteConfirmation());
                this.deleteConfirmationOverlay.addEventListener('click', (e) => {
                    if (e.target === this.deleteConfirmationOverlay) {
                        this.hideDeleteConfirmation();
                    }
                });
                
                // ESCé”®å…³é—­å¯¹è¯æ¡†
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape' && this.deleteConfirmationOverlay.style.display === 'flex') {
                        this.hideDeleteConfirmation();
                    }
                });
            }

            showBatchDeleteToolbar() {
                const lines = chatInputLines.querySelectorAll('.input-line');
                if (lines.length > 1) {
                    this.batchDeleteToolbar.style.display = 'flex';
                } else {
                    this.batchDeleteToolbar.style.display = 'none';
                }
            }

            enterBatchDeleteMode() {
                this.batchDeleteMode = true;
                this.batchSelectedButtons.clear();
                
                // æ·»åŠ æ‰¹é‡åˆ é™¤æ¨¡å¼çš„CSSç±»
                chatInputLines.classList.add('batch-delete-mode');
                
                // æ›´æ–°å·¥å…·æ æŒ‰é’®æ˜¾ç¤º
                const enterBtn = this.batchDeleteToolbar.querySelector('.batch-delete-enter');
                const confirmBtn = this.batchDeleteToolbar.querySelector('.batch-delete-confirm');
                const cancelBtn = this.batchDeleteToolbar.querySelector('.batch-delete-cancel');
                
                enterBtn.style.display = 'none';
                confirmBtn.style.display = 'inline-block';
                cancelBtn.style.display = 'inline-block';
                
                this.showToast('å·²è¿›å…¥æ‰¹é‡åˆ é™¤æ¨¡å¼ï¼Œç‚¹å‡»åˆ é™¤æŒ‰é’®é€‰æ‹©è¦åˆ é™¤çš„è¡Œ', 'info');
            }

            exitBatchDeleteMode() {
                this.batchDeleteMode = false;
                this.batchSelectedButtons.clear();
                
                // ç§»é™¤æ‰¹é‡åˆ é™¤æ¨¡å¼çš„CSSç±»
                chatInputLines.classList.remove('batch-delete-mode');
                
                // æ¸…é™¤æ‰€æœ‰é€‰ä¸­çŠ¶æ€
                const allDeleteBtns = chatInputLines.querySelectorAll('.delete-line-btn');
                allDeleteBtns.forEach(btn => btn.classList.remove('batch-selected'));
                
                // æ›´æ–°å·¥å…·æ æŒ‰é’®æ˜¾ç¤º
                const enterBtn = this.batchDeleteToolbar.querySelector('.batch-delete-enter');
                const confirmBtn = this.batchDeleteToolbar.querySelector('.batch-delete-confirm');
                const cancelBtn = this.batchDeleteToolbar.querySelector('.batch-delete-cancel');
                
                enterBtn.style.display = 'inline-block';
                confirmBtn.style.display = 'none';
                cancelBtn.style.display = 'none';
                
                this.showToast('å·²é€€å‡ºæ‰¹é‡åˆ é™¤æ¨¡å¼', 'info');
            }

            clearAllContent() {
                // æ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡†
                this.showDeleteConfirmation(
                    'ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰è¾“å…¥å†…å®¹å—ï¼Ÿ',
                    () => {
                        // ç¡®è®¤æ¸…ç©º
                        this.performClearAll();
                    }
                );
            }

            performClearAll() {
                // è·å–æ‰€æœ‰è¾“å…¥è¡Œ
                const allLines = chatInputLines.querySelectorAll('.input-line');
                
                // å½»åº•åˆ é™¤æ‰€æœ‰è¾“å…¥è¡Œ
                allLines.forEach(line => {
                    line.remove();
                });

                // æ¸…ç©ºå®¹å™¨ä¸­çš„æ‰€æœ‰å†…å®¹
                chatInputLines.innerHTML = '';

                // åˆ›å»ºä¸€ä¸ªæ–°çš„ç©ºè¡Œ
                this.addNewLine();

                // èšç„¦åˆ°æ–°åˆ›å»ºçš„ç¬¬ä¸€è¡Œ
                setTimeout(() => {
                    const firstLine = chatInputLines.querySelector('.line-content');
                    if (firstLine) {
                        firstLine.focus();
                    }
                }, 50);

                // æ›´æ–°å­—ç¬¦è®¡æ•°
                this.updateCharCount();
                
                // æ˜¾ç¤ºæˆåŠŸæç¤º
                this.showToast('å·²æ¸…ç©ºæ‰€æœ‰è¾“å…¥å†…å®¹', 'success');
            }

            initializeClearInputButton() {
                const clearInputBtn = document.getElementById('clearInputBtn');
                if (clearInputBtn) {
                    clearInputBtn.addEventListener('click', () => {
                        this.clearAllContent();
                    });
                }
            }

            confirmBatchDelete() {
                if (this.batchSelectedButtons.size === 0) {
                    this.showToast('è¯·å…ˆé€‰æ‹©è¦åˆ é™¤çš„è¡Œ', 'warning');
                    return;
                }
                
                this.confirmDeleteBatchSelected();
            }

            toggleBatchSelectButton(deleteBtn) {
                if (!this.batchDeleteMode) return;
                
                if (this.batchSelectedButtons.has(deleteBtn)) {
                    this.batchSelectedButtons.delete(deleteBtn);
                    deleteBtn.classList.remove('batch-selected');
                } else {
                    this.batchSelectedButtons.add(deleteBtn);
                    deleteBtn.classList.add('batch-selected');
                }
                
                // æ›´æ–°ç¡®è®¤æŒ‰é’®æ–‡æœ¬
                const confirmBtn = this.batchDeleteToolbar.querySelector('.batch-delete-confirm');
                if (this.batchSelectedButtons.size > 0) {
                    confirmBtn.textContent = `åˆ é™¤é€‰ä¸­ (${this.batchSelectedButtons.size})`;
                } else {
                    confirmBtn.textContent = 'åˆ é™¤é€‰ä¸­';
                }
            }

            showDeleteConfirmation(message, onConfirm) {
                this.deleteConfirmationMessage.textContent = message;
                this.deleteConfirmationOverlay.style.display = 'flex';
                
                // ç§»é™¤ä¹‹å‰çš„äº‹ä»¶ç›‘å¬å™¨
                const newConfirmBtn = this.deleteConfirmationConfirm.cloneNode(true);
                this.deleteConfirmationConfirm.parentNode.replaceChild(newConfirmBtn, this.deleteConfirmationConfirm);
                this.deleteConfirmationConfirm = newConfirmBtn;
                
                // æ·»åŠ æ–°çš„ç¡®è®¤äº‹ä»¶
                this.deleteConfirmationConfirm.addEventListener('click', () => {
                    this.hideDeleteConfirmation();
                    onConfirm();
                });
            }

            hideDeleteConfirmation() {
                this.deleteConfirmationOverlay.style.display = 'none';
            }

            // å¤„ç†åˆ é™¤è¡Œåçš„å…‰æ ‡å®šä½å’Œé€‰ä¸­
            handlePostDeleteFocus(deletedLineIndex, totalLinesBeforeDelete) {
                const lines = chatInputLines.querySelectorAll('.input-line');
                let targetLine = null;
                
                if (lines.length === 0) {
                    // å¦‚æœæ²¡æœ‰è¡Œäº†ï¼Œä¸éœ€è¦å¤„ç†
                    return;
                }
                
                // ç¡®å®šç›®æ ‡è¡Œï¼šä¼˜å…ˆé€‰æ‹©ä¸‹ä¸€è¡Œï¼Œå¦‚æœæ²¡æœ‰ä¸‹ä¸€è¡Œåˆ™é€‰æ‹©ä¸Šä¸€è¡Œ
                if (deletedLineIndex < lines.length) {
                    // åˆ é™¤çš„ä¸æ˜¯æœ€åä¸€è¡Œï¼Œé€‰æ‹©å½“å‰ä½ç½®çš„è¡Œï¼ˆåŸæ¥çš„ä¸‹ä¸€è¡Œï¼‰
                    targetLine = lines[deletedLineIndex];
                } else {
                    // åˆ é™¤çš„æ˜¯æœ€åä¸€è¡Œï¼Œé€‰æ‹©æ–°çš„æœ€åä¸€è¡Œ
                    targetLine = lines[lines.length - 1];
                }
                
                if (targetLine) {
                    // æ¸…é™¤ç°æœ‰é€‰ä¸­çŠ¶æ€
                    this.clearSelection();
                    
                    // é€‰ä¸­ç›®æ ‡è¡Œ
                    this.selectLine(targetLine);
                    
                    // å°†å…‰æ ‡å®šä½åˆ°ç›®æ ‡è¡Œçš„å†…å®¹åŒºåŸŸ
                    const lineContent = targetLine.querySelector('.line-content');
                    if (lineContent) {
                        lineContent.focus();
                        // å°†å…‰æ ‡å®šä½åˆ°è¡Œé¦–
                        const range = document.createRange();
                        const selection = window.getSelection();
                        range.setStart(lineContent, 0);
                        range.collapse(true);
                        selection.removeAllRanges();
                        selection.addRange(range);
                    }
                }
            }

            // ç›´æ¥æ‰§è¡Œåˆ é™¤æ“ä½œ
            deleteLine(lineElement) {
                const lines = chatInputLines.querySelectorAll('.input-line');
                if (lines.length === 1) {
                    // å¦‚æœåªæœ‰ä¸€è¡Œï¼Œæ¸…ç©ºå†…å®¹
                    const content = lineElement.querySelector('.line-content');
                    const originalContent = content.textContent || '';
                    
                    // ä¿å­˜æ’¤é”€çŠ¶æ€
                    this.saveUndoState('clear_line_content', {
                        lineElement: lineElement,
                        originalContent: originalContent
                    });
                    
                    content.textContent = '';
                    content.focus();
                    this.syncWithOriginalTextarea();
                    this.showUndoNotification('å·²æ¸…ç©ºè¡Œå†…å®¹');
                } else {
                    // åˆ é™¤æ•´è¡Œ
                    // è·å–åˆ é™¤è¡Œçš„ç´¢å¼•
                    const lineIndex = Array.from(lines).indexOf(lineElement);
                    const totalLinesBeforeDelete = lines.length;
                    const clonedLine = lineElement.cloneNode(true);
                    
                    // ä¿å­˜æ’¤é”€çŠ¶æ€
                    this.saveUndoState('delete_single_line', {
                        deletedLine: clonedLine,
                        insertPosition: lineIndex
                    });
                    
                    // åˆ é™¤è¡Œ
                    lineElement.remove();
                    
                    // å¤„ç†åˆ é™¤åçš„å…‰æ ‡å®šä½å’Œé€‰ä¸­
                    this.handlePostDeleteFocus(lineIndex, totalLinesBeforeDelete);
                    
                    this.syncWithOriginalTextarea();
                    this.showBatchDeleteToolbar();
                    this.showUndoNotification('å·²åˆ é™¤ 1 è¡Œ');
                }
            }

            confirmDeleteBatchSelected() {
                const selectedCount = this.batchSelectedButtons.size;
                // è·å–è¦åˆ é™¤çš„è¡Œå…ƒç´ 
                const linesToDelete = Array.from(this.batchSelectedButtons).map(btn => 
                    btn.closest('.input-line')
                );
                const allLines = Array.from(chatInputLines.querySelectorAll('.input-line'));
                
                // ä¿å­˜æ’¤é”€çŠ¶æ€
                const deletedLines = linesToDelete.map(line => line.cloneNode(true));
                const insertPositions = linesToDelete.map(line => allLines.indexOf(line));
                
                this.saveUndoState('delete_lines', {
                    deletedLines: deletedLines,
                    insertPositions: insertPositions
                });
                
                // åˆ é™¤é€‰ä¸­çš„è¡Œ
                linesToDelete.forEach(line => line.remove());
                
                // é€€å‡ºæ‰¹é‡åˆ é™¤æ¨¡å¼
                this.exitBatchDeleteMode();
                
                // åŒæ­¥æ•°æ®
                this.syncWithOriginalTextarea();
                this.showBatchDeleteToolbar();
                
                this.showUndoNotification(`å·²åˆ é™¤ ${selectedCount} è¡Œ`);
            }

             // æ’¤é”€åŠŸèƒ½
             initializeUndo() {
                 this.undoStack = [];
                 this.undoNotification = document.getElementById('undoNotification');
                 this.undoMessage = document.getElementById('undoMessage');
                 this.undoBtn = document.getElementById('undoBtn');
                 this.undoClose = document.getElementById('undoClose');
                 this.undoTimeout = null;
                 
                 // ç»‘å®šæ’¤é”€äº‹ä»¶
                 this.undoBtn.addEventListener('click', () => this.performUndo());
                 this.undoClose.addEventListener('click', () => this.hideUndoNotification());
                 
                 // Ctrl+Z å¿«æ·é”®æ’¤é”€
                 document.addEventListener('keydown', (e) => {
                     if ((e.ctrlKey || e.metaKey) && e.key === 'z' && !e.shiftKey) {
                         e.preventDefault();
                         this.performUndo();
                     }
                 });
             }

             saveUndoState(action, data) {
                 const undoData = {
                     action: action,
                     data: data,
                     timestamp: Date.now()
                 };
                 
                 this.undoStack.push(undoData);
                 
                 // é™åˆ¶æ’¤é”€æ ˆå¤§å°
                 if (this.undoStack.length > 10) {
                     this.undoStack.shift();
                 }
             }

             showUndoNotification(message) {
                 this.undoMessage.textContent = message;
                 this.undoNotification.style.display = 'flex';
                 
                 // æ¸…é™¤ä¹‹å‰çš„å®šæ—¶å™¨
                 if (this.undoTimeout) {
                     clearTimeout(this.undoTimeout);
                 }
                 
                 // 5ç§’åè‡ªåŠ¨éšè—
                 this.undoTimeout = setTimeout(() => {
                     this.hideUndoNotification();
                 }, 5000);
             }

             hideUndoNotification() {
                 this.undoNotification.style.display = 'none';
                 if (this.undoTimeout) {
                     clearTimeout(this.undoTimeout);
                     this.undoTimeout = null;
                 }
             }

             performUndo() {
                 if (this.undoStack.length === 0) {
                     this.showToast('æ²¡æœ‰å¯æ’¤é”€çš„æ“ä½œ', 'warning');
                     return;
                 }
                 
                 const undoData = this.undoStack.pop();
                 this.hideUndoNotification();
                 
                 switch (undoData.action) {
                     case 'delete_lines':
                         this.undoDeleteLines(undoData.data);
                         break;
                     case 'delete_single_line':
                         this.undoDeleteSingleLine(undoData.data);
                         break;
                     case 'clear_line_content':
                         this.undoClearLineContent(undoData.data);
                         break;
                 }
                 
                 this.syncWithOriginalTextarea();
                 this.showToast('å·²æ’¤é”€æ“ä½œ', 'success');
             }

             undoDeleteLines(data) {
                 const { deletedLines, insertPositions } = data;
                 
                 // æŒ‰ä½ç½®æ­£åºæ’å…¥ï¼Œé¿å…ä½ç½®åç§»
                 const sortedData = deletedLines.map((line, index) => ({
                     line: line,
                     position: insertPositions[index]
                 })).sort((a, b) => a.position - b.position);
                 
                 sortedData.forEach(item => {
                     const { line, position } = item;
                     const clonedLine = line.cloneNode(true);
                     
                     const existingLines = chatInputLines.querySelectorAll('.input-line');
                     
                     if (position >= existingLines.length) {
                         chatInputLines.appendChild(clonedLine);
                     } else {
                         chatInputLines.insertBefore(clonedLine, existingLines[position]);
                     }
                 });
                 
                 this.syncWithOriginalTextarea();
             }

             undoDeleteSingleLine(data) {
                 const { deletedLine, insertPosition } = data;
                 const clonedLine = deletedLine.cloneNode(true);
                 
                 const existingLines = chatInputLines.querySelectorAll('.input-line');
                 
                 if (insertPosition >= existingLines.length) {
                     chatInputLines.appendChild(clonedLine);
                 } else {
                     chatInputLines.insertBefore(clonedLine, existingLines[insertPosition]);
                 }
                 
                 this.syncWithOriginalTextarea();
             }

             undoClearLineContent(data) {
                 const { lineElement, originalContent } = data;
                 const contentElement = lineElement.querySelector('.line-content');
                 if (contentElement) {
                     contentElement.textContent = originalContent;
                     this.syncWithOriginalTextarea();
                 }
             }
        }

        // åˆå§‹åŒ–è¡Œç¼–è¾‘å™¨
        document.addEventListener('DOMContentLoaded', function() {
            const lineEditor = new LineEditor();
            window.lineEditor = lineEditor;
        });
        
        // æ”¹è¿›çš„é”™è¯¯æç¤ºå‡½æ•°
        function showErrorToast(message, type = 'error', duration = 5000) {
            // ç§»é™¤å·²å­˜åœ¨çš„æç¤º
            const existingToast = document.querySelector('.toast-notification');
            if (existingToast) {
                existingToast.remove();
            }

            // æ ¹æ®é”™è¯¯ç±»å‹æä¾›è§£å†³å»ºè®®
            let suggestion = '';
            if (message.includes('æ–‡ä»¶è¿‡å¤§')) {
                suggestion = 'å»ºè®®ï¼šå‹ç¼©å›¾ç‰‡æˆ–é€‰æ‹©è¾ƒå°çš„æ–‡ä»¶';
            } else if (message.includes('æ ¼å¼ä¸æ”¯æŒ')) {
                suggestion = 'å»ºè®®ï¼šè¯·é€‰æ‹©JPGã€PNGæˆ–BMPæ ¼å¼çš„å›¾ç‰‡';
            } else if (message.includes('ç½‘ç»œ')) {
                suggestion = 'å»ºè®®ï¼šæ£€æŸ¥ç½‘ç»œè¿æ¥ï¼Œç¨åé‡è¯•';
            } else if (message.includes('æœªè¯†åˆ«åˆ°æ–‡å­—')) {
                suggestion = 'å»ºè®®ï¼šç¡®ä¿å›¾ç‰‡æ¸…æ™°ï¼Œæ–‡å­—æ¸…æ¥šå¯è§';
            } else if (message.includes('æœåŠ¡å™¨')) {
                suggestion = 'å»ºè®®ï¼šæœåŠ¡æš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·ç¨åé‡è¯•';
            }

            // åˆ›å»ºæ–°çš„æç¤º
            const toast = document.createElement('div');
            toast.className = `toast-notification toast-${type}`;
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                max-width: 400px;
                background: ${type === 'error' ? '#dc3545' : type === 'warning' ? '#ffc107' : '#28a745'};
                color: white;
                padding: 16px 20px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
                z-index: 10000;
                transform: translateX(100%);
                transition: transform 0.3s ease;
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                font-size: 14px;
                line-height: 1.4;
            `;

            const icon = type === 'error' ? 'âŒ' : type === 'warning' ? 'âš ï¸' : 'âœ…';
            
            toast.innerHTML = `
                <div style="display: flex; align-items: flex-start; gap: 10px;">
                    <span style="font-size: 16px; flex-shrink: 0;">${icon}</span>
                    <div style="flex: 1;">
                        <div style="font-weight: 500; margin-bottom: ${suggestion ? '4px' : '0'};">${message}</div>
                        ${suggestion ? `<div style="font-size: 12px; opacity: 0.9; font-style: italic;">${suggestion}</div>` : ''}
                    </div>
                    <button style="
                        background: none; 
                        border: none; 
                        color: white; 
                        font-size: 18px; 
                        cursor: pointer; 
                        padding: 0; 
                        margin-left: 10px; 
                        opacity: 0.8;
                        flex-shrink: 0;
                    " onclick="this.closest('.toast-notification').remove()">Ã—</button>
                </div>
            `;

            // æ·»åŠ åˆ°é¡µé¢
            document.body.appendChild(toast);

            // æ˜¾ç¤ºåŠ¨ç”»
            setTimeout(() => {
                toast.style.transform = 'translateX(0)';
            }, 100);

            // è‡ªåŠ¨æ¶ˆå¤±
            setTimeout(() => {
                if (toast.parentElement) {
                    toast.style.transform = 'translateX(100%)';
                    setTimeout(() => {
                        if (toast.parentElement) {
                            toast.remove();
                        }
                    }, 300);
                }
            }, duration);

            return toast;
        }

        // æˆåŠŸæç¤ºå‡½æ•°ï¼ˆä¿æŒå…¼å®¹æ€§ï¼‰
        function showSuccessToast(message, duration = 3000) {
            return showErrorToast(message, 'success', duration);
        }

        // è­¦å‘Šæç¤ºå‡½æ•°
        function showWarningToast(message, duration = 4000) {
            return showErrorToast(message, 'warning', duration);
        }

        // å°†base64æ•°æ®URLè½¬æ¢ä¸ºBlobå¯¹è±¡
        function dataURLToBlob(dataURL) {
            const arr = dataURL.split(',');
            const mime = arr[0].match(/:(.*?);/)[1];
            const bstr = atob(arr[1]);
            let n = bstr.length;
            const u8arr = new Uint8Array(n);
            while (n--) {
                u8arr[n] = bstr.charCodeAt(n);
            }
            return new Blob([u8arr], { type: mime });
        }

        // OCRè¯†åˆ«åŠŸèƒ½
        async function performOCR() {
            if (!currentImageData) {
                showErrorToast('è¯·å…ˆç²˜è´´æˆ–æ‹–æ‹½ä¸€å¼ å›¾ç‰‡');
                return;
            }
            
            // ç¦ç”¨OCRæŒ‰é’®ï¼Œæ˜¾ç¤ºè¿›åº¦
            if (ocrBtn) {
                ocrBtn.disabled = true;
                ocrBtn.textContent = 'è¯†åˆ«ä¸­...';
                ocrBtn.style.opacity = '0.6';
            }
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            if (ocrResult) ocrResult.style.display = 'block';
            if (ocrStatusText) ocrStatusText.textContent = 'æ­£åœ¨è¯†åˆ«ä¸­...';
            const spinner = ocrResult ? ocrResult.querySelector('.loading-spinner') : null;
            if (spinner) spinner.style.display = 'block';
            
            try {
                // å°†base64å›¾ç‰‡æ•°æ®è½¬æ¢ä¸ºblob
                const blob = dataURLToBlob(currentImageData);
                
                // æ£€æŸ¥å›¾ç‰‡å¤§å°
                if (blob.size > 10 * 1024 * 1024) {
                    throw new Error('å›¾ç‰‡æ–‡ä»¶è¿‡å¤§ï¼Œè¯·é€‰æ‹©å°äº10MBçš„å›¾ç‰‡');
                }
                
                // åˆ›å»ºFormData
                const formData = new FormData();
                formData.append('image', blob, 'image.png');
                
                // æ˜¾ç¤ºä¸Šä¼ è¿›åº¦
                if (ocrStatusText) ocrStatusText.textContent = 'æ­£åœ¨ä¸Šä¼ å›¾ç‰‡...';
                
                // å‘é€OCRè¯·æ±‚
                const ocrResponse = await fetch('/api/ocr', {
                    method: 'POST',
                    body: formData
                });
                
                if (ocrStatusText) ocrStatusText.textContent = 'æ­£åœ¨è¯†åˆ«æ–‡å­—...';
                
                if (ocrResponse.ok) {
                    const result = await ocrResponse.json();
                    
                    if (result.success && result.text && result.text.trim()) {
                        // æ˜¾ç¤ºè¯†åˆ«ç»“æœ
                        if (ocrStatusText) ocrStatusText.textContent = 'è¯†åˆ«å®Œæˆ';
                        if (spinner) spinner.style.display = 'none';
                        
                        // åˆ›å»ºç»“æœæ˜¾ç¤ºåŒºåŸŸ
                        let ocrTextDiv = ocrResult ? ocrResult.querySelector('.ocr-text') : null;
                        if (!ocrTextDiv && ocrResult) {
                            ocrTextDiv = document.createElement('div');
                            ocrTextDiv.className = 'ocr-text';
                            ocrTextDiv.style.cssText = `
                                margin-top: 10px;
                                padding: 10px;
                                background: #f8f9fa;
                                border-radius: 4px;
                                border: 1px solid #e9ecef;
                                white-space: pre-wrap;
                                font-family: monospace;
                                font-size: 14px;
                                max-height: 200px;
                                overflow-y: auto;
                            `;
                            ocrResult.appendChild(ocrTextDiv);
                        }
                        
                        if (ocrTextDiv) ocrTextDiv.textContent = result.text;
                        
                        // è‡ªåŠ¨å¡«å……åˆ°æ–°çš„è¡Œç¼–è¾‘å™¨
                        if (window.lineEditor) {
                            const lines = result.text.split('\n');
                            // æ£€æŸ¥æ˜¯å¦æœ‰ç°æœ‰å†…å®¹ï¼Œå¦‚æœæœ‰åˆ™å…ˆæ·»åŠ ä¸€ä¸ªç©ºè¡Œåˆ†éš”
                            const existingLines = document.querySelectorAll('#chatInputLines .input-line');
                            const hasExistingContent = Array.from(existingLines).some(line => {
                                const content = line.querySelector('.line-content');
                                return content && content.textContent.trim();
                            });
                            
                            if (hasExistingContent) {
                                window.lineEditor.addNewLine(''); // æ·»åŠ ç©ºè¡Œåˆ†éš”
                            }
                            
                            // æ·»åŠ è¯†åˆ«å‡ºçš„æ–‡æœ¬è¡Œ
                            lines.forEach(line => {
                                // ä¿ç•™ç©ºè¡Œï¼Œä»¥ä¿æŒåŸå§‹æ ¼å¼
                                window.lineEditor.addNewLine(line);
                            });
                        } else {
                            // å›é€€åˆ°åŸå§‹textarea
                            const chatInput = document.getElementById('chatInput');
                            if (chatInput) {
                                const currentValue = chatInput.value;
                                chatInput.value = currentValue ? currentValue + '\n' + result.text : result.text;
                                updateCharCount();
                            }
                        }
                        
                        showSuccessToast('æ–‡å­—è¯†åˆ«å®Œæˆï¼Œå·²è‡ªåŠ¨æ·»åŠ åˆ°æ–‡æœ¬æ¡†');
                        
                    } else if (result.success && (!result.text || !result.text.trim())) {
                        throw new Error('å›¾ç‰‡ä¸­æœªè¯†åˆ«åˆ°æ–‡å­—å†…å®¹ï¼Œè¯·ç¡®ä¿å›¾ç‰‡æ¸…æ™°ä¸”åŒ…å«æ–‡å­—');
                    } else {
                        throw new Error(result.message || 'è¯†åˆ«å¤±è´¥ï¼Œè¯·é‡è¯•');
                    }
                } else {
                    const errorText = await ocrResponse.text();
                    console.error('OCRæœåŠ¡å™¨å“åº”é”™è¯¯:', errorText);
                    
                    if (ocrResponse.status === 413) {
                        throw new Error('å›¾ç‰‡æ–‡ä»¶è¿‡å¤§ï¼Œè¯·é€‰æ‹©è¾ƒå°çš„å›¾ç‰‡');
                    } else if (ocrResponse.status === 400) {
                        throw new Error('å›¾ç‰‡æ ¼å¼ä¸æ”¯æŒï¼Œè¯·é€‰æ‹©JPGã€PNGæˆ–BMPæ ¼å¼çš„å›¾ç‰‡');
                    } else if (ocrResponse.status >= 500) {
                        throw new Error('æœåŠ¡å™¨æš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·ç¨åé‡è¯•');
                    } else {
                        throw new Error(`è¯†åˆ«å¤±è´¥ (é”™è¯¯ä»£ç : ${ocrResponse.status})ï¼Œè¯·é‡è¯•`);
                    }
                }
            } catch (error) {
                console.error('OCRè¯†åˆ«å¤±è´¥:', error);
                
                // æ˜¾ç¤ºè¯¦ç»†é”™è¯¯ä¿¡æ¯
                if (ocrStatusText) ocrStatusText.textContent = 'è¯†åˆ«å¤±è´¥: ' + error.message;
                if (spinner) spinner.style.display = 'none';
                
                // æ ¹æ®é”™è¯¯ç±»å‹æ˜¾ç¤ºä¸åŒçš„æç¤º
                if (error.message.includes('ç½‘ç»œ')) {
                    showErrorToast('ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥åé‡è¯•');
                } else if (error.message.includes('æ–‡ä»¶è¿‡å¤§')) {
                    showErrorToast('å›¾ç‰‡æ–‡ä»¶è¿‡å¤§ï¼Œè¯·é€‰æ‹©å°äº10MBçš„å›¾ç‰‡');
                } else if (error.message.includes('æ ¼å¼')) {
                    showErrorToast('å›¾ç‰‡æ ¼å¼ä¸æ”¯æŒï¼Œè¯·é€‰æ‹©JPGã€PNGæˆ–BMPæ ¼å¼çš„å›¾ç‰‡');
                } else {
                    showErrorToast('OCRè¯†åˆ«å¤±è´¥: ' + error.message);
                }
            } finally {
                // æ¢å¤OCRæŒ‰é’®çŠ¶æ€
                if (ocrBtn) {
                    ocrBtn.disabled = false;
                    ocrBtn.textContent = 'ğŸ” è¯†åˆ«æ–‡å­—';
                    ocrBtn.style.opacity = '1';
                }
            }
        }

        // å­—ç¬¦è®¡æ•°åŠŸèƒ½
        function updateCharCount() {
            const count = chatInput.value.length;
            charCount.textContent = count;
            
            // æ ¹æ®å­—ç¬¦æ•°æ”¹å˜é¢œè‰²
            if (count > 1000) {
                charCount.style.color = '#ff6b6b';
            } else if (count > 500) {
                charCount.style.color = '#ffa726';
            } else {
                charCount.style.color = '#666';
            }
        }

        // ç›‘å¬è¾“å…¥å†…å®¹å˜åŒ–ï¼Œä»…æ›´æ–°å­—ç¬¦è®¡æ•°
        chatInput.addEventListener('input', function() {
            updateCharCount();
        });

        // ç”ŸæˆæŒ‰é’®ç‚¹å‡»äº‹ä»¶
        generateBtn.addEventListener('click', function() {
            const content = chatInput.value.trim();
            const selectedRegion = regionSelect.value;
            
            if (!content) {
                showErrorToast('è¯·è¾“å…¥èŠå¤©å†…å®¹ï¼');
                // èšç„¦åˆ°æ–°çš„è¾“å…¥ç»„ä»¶çš„ç¬¬ä¸€è¡Œ
                const firstLine = chatInputLines.querySelector('.line-content');
                if (firstLine) {
                    firstLine.focus();
                }
                return;
            }

            // æ·»åŠ åŠ è½½çŠ¶æ€
            this.classList.add('loading');
            this.disabled = true;
            this.textContent = 'ç”Ÿæˆä¸­...';

            // æ›´æ–°iframeçš„src URLï¼Œå°†æ–‡æœ¬å†…å®¹ä½œä¸ºå‚æ•°ä¼ é€’
            try {
                // å¯¹æ–‡æœ¬å†…å®¹è¿›è¡ŒURLç¼–ç å¤„ç†
                const encodedContent = encodeURIComponent(content);
                // æ„å»ºæ–°çš„URLï¼Œæ·»åŠ chatContentå‚æ•°ã€xianluå‚æ•°å’Œplatformå‚æ•°
                const baseUrl = '/generateDyChat';
                const selectedPlatform = platformSelect.value;
                let newUrl = `${baseUrl}?xianlu=${encodeURIComponent(selectedRegion)}&chatContent=${encodedContent}&platform=${encodeURIComponent(selectedPlatform)}`;
                // æ›´æ–°iframeçš„src
                previewFrame.src = newUrl;
                
                console.log('æ›´æ–°iframe URL:', newUrl);
                console.log('ç”ŸæˆèŠå¤©æˆªå›¾:', content);
            } catch (e) {
                console.log('æ›´æ–°iframe URLå¤±è´¥:', e);
            }

            // æ¨¡æ‹Ÿç”Ÿæˆè¿‡ç¨‹å®Œæˆ
            setTimeout(() => {
                // ç§»é™¤åŠ è½½çŠ¶æ€
                this.classList.remove('loading');
                this.disabled = false;
                this.innerHTML = 'ğŸ¨ ç”ŸæˆèŠå¤©æˆªå›¾';
            }, 1500);
        });
        
        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        // å›¾ç‰‡ç²˜è´´åŠŸèƒ½
        function initImagePasteFeature() {
            // ä½¿ç”¨æ­£ç¡®çš„å…ƒç´ å¼•ç”¨
            const pasteArea = imagePasteArea; // ä½¿ç”¨å·²å®šä¹‰çš„imagePasteArea
            const pasteText = document.querySelector('#imagePasteArea .paste-placeholder');
            
            if (!pasteArea || !imagePreview || !ocrBtn) {
                console.warn('å›¾ç‰‡ç²˜è´´åŠŸèƒ½ç›¸å…³å…ƒç´ æœªæ‰¾åˆ°');
                return;
            }

            // å¤„ç†ç²˜è´´äº‹ä»¶
            function handlePaste(e) {
                const items = e.clipboardData.items;
                for (let i = 0; i < items.length; i++) {
                    if (items[i].type.indexOf('image') !== -1) {
                        const blob = items[i].getAsFile();
                        handleImageFile(blob);
                        e.preventDefault();
                        break;
                    }
                }
            }

            // å¤„ç†æ‹–æ‹½äº‹ä»¶
            function handleDragOver(e) {
                e.preventDefault();
                pasteArea.style.backgroundColor = '#f0f8ff';
                pasteArea.style.borderColor = '#007bff';
            }

            function handleDragLeave(e) {
                e.preventDefault();
                pasteArea.style.backgroundColor = '';
                pasteArea.style.borderColor = '';
            }

            function handleDrop(e) {
                e.preventDefault();
                pasteArea.style.backgroundColor = '';
                pasteArea.style.borderColor = '';
                
                const files = e.dataTransfer.files;
                if (files.length > 0 && files[0].type.indexOf('image') !== -1) {
                    handleImageFile(files[0]);
                } else {
                    showErrorToast('è¯·æ‹–æ‹½å›¾ç‰‡æ–‡ä»¶');
                }
            }

            // å¤„ç†å›¾ç‰‡æ–‡ä»¶
            function handleImageFile(file) {
                // æ£€æŸ¥æ–‡ä»¶å¤§å°ï¼ˆé™åˆ¶ä¸º5MBï¼‰
                if (file.size > 5 * 1024 * 1024) {
                    showErrorToast('å›¾ç‰‡æ–‡ä»¶è¿‡å¤§ï¼Œè¯·é€‰æ‹©å°äº5MBçš„å›¾ç‰‡');
                    return;
                }

                const reader = new FileReader();
                reader.onload = function(e) {
                    currentImageData = e.target.result;
                    if (previewImg) {
                        previewImg.src = e.target.result;
                        previewImg.style.display = 'block';
                    }
                    
                    // æ˜¾ç¤ºé¢„è§ˆåŒºåŸŸ
                    if (imagePreview) imagePreview.style.display = 'flex';
                    if (ocrBtn) ocrBtn.style.display = 'inline-block';
                    if (clearBtn) clearBtn.style.display = 'inline-block';
                    
                    // éšè—å ä½ç¬¦
                    if (pasteText) pasteText.style.display = 'none';
                    
                    showSuccessToast('å›¾ç‰‡ä¸Šä¼ æˆåŠŸï¼Œå¯ä»¥è¿›è¡Œæ–‡å­—è¯†åˆ«');
                };
                
                reader.onerror = function() {
                    showErrorToast('å›¾ç‰‡è¯»å–å¤±è´¥ï¼Œè¯·é‡è¯•');
                };
                
                reader.readAsDataURL(file);
            }

            // ç§»é™¤å›¾ç‰‡
            function removeImage() {
                currentImageData = null;
                if (previewImg) {
                    previewImg.src = '';
                    previewImg.style.display = 'none';
                }
                if (imagePreview) imagePreview.style.display = 'none';
                if (ocrBtn) ocrBtn.style.display = 'none';
                if (clearBtn) clearBtn.style.display = 'none';
                if (ocrResult) ocrResult.style.display = 'none';
                if (pasteText) pasteText.style.display = 'block';
            }

            // ç»‘å®šäº‹ä»¶
            document.addEventListener('paste', handlePaste);
            pasteArea.addEventListener('dragover', handleDragOver);
            pasteArea.addEventListener('dragleave', handleDragLeave);
            pasteArea.addEventListener('drop', handleDrop);
            
            // ç§»åŠ¨ç«¯è®¾å¤‡æ£€æµ‹å‡½æ•°
        function isMobileDevice() {
            return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ||
                   (navigator.maxTouchPoints && navigator.maxTouchPoints > 2 && /MacIntel/.test(navigator.platform));
        }

        // ç»‘å®šæ–‡ä»¶è¾“å…¥äº‹ä»¶
        if (fileInput) {
            fileInput.addEventListener('change', function(e) {
                const files = e.target.files;
                if (files.length > 0) {
                    handleImageFile(files[0]);
                }
            });
        }

        // ä¸ºç§»åŠ¨ç«¯æ·»åŠ æ–‡ä»¶ä¸Šä¼ åŒºåŸŸç‚¹å‡»äº‹ä»¶
        if (imagePasteArea && isMobileDevice()) {
            imagePasteArea.addEventListener('click', function(e) {
                // å¦‚æœç‚¹å‡»çš„æ˜¯æ¸…é™¤æŒ‰é’®æˆ–OCRæŒ‰é’®ï¼Œä¸è§¦å‘æ–‡ä»¶é€‰æ‹©
                if (e.target.closest('.clear-btn') || e.target.closest('.ocr-btn')) {
                    return;
                }
                
                // è§¦å‘æ–‡ä»¶é€‰æ‹©å¯¹è¯æ¡†
                if (fileInput) {
                    fileInput.click();
                }
            });
            
            // ä¸ºç§»åŠ¨ç«¯æ·»åŠ è§†è§‰æç¤ºæ ·å¼
            imagePasteArea.style.cursor = 'pointer';
        }
            
            // ç»‘å®šæ¸…é™¤æŒ‰é’®äº‹ä»¶
            if (clearBtn) {
                clearBtn.addEventListener('click', function(event) {
                    event.stopPropagation(); // é˜»æ­¢äº‹ä»¶å†’æ³¡
                    event.preventDefault();  // é˜»æ­¢é»˜è®¤è¡Œä¸º
                    removeImage();
                });
            }
            
            // ç»‘å®šOCRæŒ‰é’®äº‹ä»¶
            if (ocrBtn) {
                ocrBtn.addEventListener('click', function(event) {
                    event.stopPropagation(); // é˜»æ­¢äº‹ä»¶å†’æ³¡
                    event.preventDefault();  // é˜»æ­¢é»˜è®¤è¡Œä¸º
                    performOCR();
                });
            }
            

        }

        document.addEventListener('DOMContentLoaded', function() {
            updateCharCount();
            chatInput.focus();
            initImagePasteFeature();
        });

        // é”®ç›˜å¿«æ·é”®æ”¯æŒ
        document.addEventListener('keydown', function(e) {
            // Ctrl/Cmd + Enter å¿«é€Ÿç”Ÿæˆ
            if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                e.preventDefault();
                generateBtn.click();
            }
        });

        // ä¸ºtextareaæ·»åŠ ä¸“é—¨çš„å¿«æ·é”®æ”¯æŒ
        chatInput.addEventListener('keydown', function(e) {
            // Command/Ctrl + Delete åˆ é™¤å½“å‰æ•´è¡Œ
            if ((e.metaKey || e.ctrlKey) && (e.key === 'Delete' || e.key === 'Backspace')) {
                e.preventDefault();
                
                const textarea = e.target;
                const value = textarea.value;
                const selectionStart = textarea.selectionStart;
                const selectionEnd = textarea.selectionEnd;
                
                // æ‰¾åˆ°å½“å‰å…‰æ ‡æ‰€åœ¨è¡Œçš„å¼€å§‹å’Œç»“æŸä½ç½®
                let lineStart = value.lastIndexOf('\n', selectionStart - 1) + 1;
                let lineEnd = value.indexOf('\n', selectionEnd);
                
                // å¦‚æœæ²¡æœ‰æ‰¾åˆ°æ¢è¡Œç¬¦ï¼Œè¯´æ˜æ˜¯æœ€åä¸€è¡Œ
                if (lineEnd === -1) {
                    lineEnd = value.length;
                } else {
                    // åŒ…å«æ¢è¡Œç¬¦ä¸€èµ·åˆ é™¤
                    lineEnd += 1;
                }
                
                // åˆ é™¤æ•´è¡Œå†…å®¹
                const newValue = value.substring(0, lineStart) + value.substring(lineEnd);
                textarea.value = newValue;
                
                // è®¾ç½®å…‰æ ‡ä½ç½®åˆ°è¡Œé¦–
                textarea.setSelectionRange(lineStart, lineStart);
                
                // æ›´æ–°å­—ç¬¦è®¡æ•°
                updateCharCount();
            }
            
            // Command/Ctrl + D å¤åˆ¶å½“å‰è¡Œ
            if ((e.metaKey || e.ctrlKey) && e.key === 'd') {
                e.preventDefault();
                
                const textarea = e.target;
                const value = textarea.value;
                const selectionStart = textarea.selectionStart;
                const selectionEnd = textarea.selectionEnd;
                
                // æ‰¾åˆ°å½“å‰å…‰æ ‡æ‰€åœ¨è¡Œçš„å¼€å§‹å’Œç»“æŸä½ç½®
                let lineStart = value.lastIndexOf('\n', selectionStart - 1) + 1;
                let lineEnd = value.indexOf('\n', selectionEnd);
                
                // å¦‚æœæ²¡æœ‰æ‰¾åˆ°æ¢è¡Œç¬¦ï¼Œè¯´æ˜æ˜¯æœ€åä¸€è¡Œ
                if (lineEnd === -1) {
                    lineEnd = value.length;
                }
                
                // è·å–å½“å‰è¡Œå†…å®¹
                const currentLine = value.substring(lineStart, lineEnd);
                
                // åœ¨å½“å‰è¡Œåé¢æ’å…¥å¤åˆ¶çš„è¡Œ
                const beforeLine = value.substring(0, lineEnd);
                const afterLine = value.substring(lineEnd);
                
                // æ„å»ºæ–°çš„æ–‡æœ¬å†…å®¹
                let newValue;
                if (lineEnd === value.length) {
                    // å¦‚æœæ˜¯æœ€åä¸€è¡Œä¸”æ²¡æœ‰æ¢è¡Œç¬¦ï¼Œå…ˆæ·»åŠ æ¢è¡Œç¬¦å†å¤åˆ¶
                    newValue = beforeLine + '\n' + currentLine + afterLine;
                } else {
                    // åœ¨æ¢è¡Œç¬¦åæ’å…¥å¤åˆ¶çš„è¡Œ
                    newValue = beforeLine + '\n' + currentLine + afterLine;
                }
                
                textarea.value = newValue;
                
                // è®¾ç½®å…‰æ ‡ä½ç½®åˆ°å¤åˆ¶è¡Œçš„ç›¸åŒä½ç½®
                const newLineStart = lineEnd + 1;
                const newSelectionStart = newLineStart + (selectionStart - lineStart);
                const newSelectionEnd = newLineStart + (selectionEnd - lineStart);
                
                textarea.setSelectionRange(newSelectionStart, newSelectionEnd);
                
                // æ›´æ–°å­—ç¬¦è®¡æ•°
                updateCharCount();
            }
            
            // Command/Ctrl + Shift + ä¸Šä¸‹ç®­å¤´é”® ç§»åŠ¨å½“å‰è¡Œ
            if ((e.metaKey || e.ctrlKey) && e.shiftKey && (e.key === 'ArrowUp' || e.key === 'ArrowDown')) {
                e.preventDefault();
                
                const textarea = e.target;
                const value = textarea.value;
                const selectionStart = textarea.selectionStart;
                const selectionEnd = textarea.selectionEnd;
                
                // æ‰¾åˆ°å½“å‰å…‰æ ‡æ‰€åœ¨è¡Œçš„å¼€å§‹å’Œç»“æŸä½ç½®
                let lineStart = value.lastIndexOf('\n', selectionStart - 1) + 1;
                let lineEnd = value.indexOf('\n', selectionEnd);
                
                // å¦‚æœæ²¡æœ‰æ‰¾åˆ°æ¢è¡Œç¬¦ï¼Œè¯´æ˜æ˜¯æœ€åä¸€è¡Œ
                if (lineEnd === -1) {
                    lineEnd = value.length;
                }
                
                // è·å–å½“å‰è¡Œå†…å®¹ï¼ˆåŒ…æ‹¬æ¢è¡Œç¬¦ï¼‰
                const currentLine = value.substring(lineStart, lineEnd);
                const hasNewline = lineEnd < value.length;
                const currentLineWithNewline = hasNewline ? currentLine + '\n' : currentLine;
                
                if (e.key === 'ArrowUp') {
                    // å‘ä¸Šç§»åŠ¨ï¼šæ‰¾åˆ°ä¸Šä¸€è¡Œ
                    if (lineStart > 0) {
                        const prevLineEnd = lineStart - 1; // ä¸Šä¸€è¡Œçš„æ¢è¡Œç¬¦ä½ç½®
                        const prevLineStart = value.lastIndexOf('\n', prevLineEnd - 1) + 1;
                        const prevLine = value.substring(prevLineStart, prevLineEnd);
                        
                        // æ„å»ºæ–°çš„æ–‡æœ¬å†…å®¹
                        const beforePrevLine = value.substring(0, prevLineStart);
                        const afterCurrentLine = value.substring(hasNewline ? lineEnd + 1 : lineEnd);
                        
                        const newValue = beforePrevLine + currentLine + '\n' + prevLine + 
                                       (hasNewline ? '\n' : '') + afterCurrentLine;
                        
                        textarea.value = newValue;
                        
                        // è®¡ç®—æ–°çš„å…‰æ ‡ä½ç½®
                        const newLineStart = prevLineStart;
                        const newSelectionStart = newLineStart + (selectionStart - lineStart);
                        const newSelectionEnd = newLineStart + (selectionEnd - lineStart);
                        
                        textarea.setSelectionRange(newSelectionStart, newSelectionEnd);
                    }
                } else if (e.key === 'ArrowDown') {
                    // å‘ä¸‹ç§»åŠ¨ï¼šæ‰¾åˆ°ä¸‹ä¸€è¡Œ
                    if (lineEnd < value.length) {
                        const nextLineStart = hasNewline ? lineEnd + 1 : lineEnd;
                        let nextLineEnd = value.indexOf('\n', nextLineStart);
                        if (nextLineEnd === -1) {
                            nextLineEnd = value.length;
                        }
                        const nextLine = value.substring(nextLineStart, nextLineEnd);
                        const nextHasNewline = nextLineEnd < value.length;
                        
                        // æ„å»ºæ–°çš„æ–‡æœ¬å†…å®¹
                        const beforeCurrentLine = value.substring(0, lineStart);
                        const afterNextLine = value.substring(nextHasNewline ? nextLineEnd + 1 : nextLineEnd);
                        
                        const newValue = beforeCurrentLine + nextLine + '\n' + currentLine + 
                                       (nextHasNewline ? '\n' : '') + afterNextLine;
                        
                        textarea.value = newValue;
                        
                        // è®¡ç®—æ–°çš„å…‰æ ‡ä½ç½®
                        const newLineStart = lineStart + nextLine.length + 1;
                        const newSelectionStart = newLineStart + (selectionStart - lineStart);
                        const newSelectionEnd = newLineStart + (selectionEnd - lineStart);
                        
                        textarea.setSelectionRange(newSelectionStart, newSelectionEnd);
                    }
                }
                
                // æ›´æ–°å­—ç¬¦è®¡æ•°
                updateCharCount();
            }
        });
        
        // æ¨¡æ€å¼¹çª—äº‹ä»¶ç›‘å¬å™¨ - ç¡®ä¿DOMåŠ è½½å®Œæˆåæ‰§è¡Œ
        document.addEventListener('DOMContentLoaded', function() {
            const rulesHelpLink = document.getElementById('rulesHelpLink');
            const rulesModal = document.getElementById('rulesModal');
            const closeModal = document.getElementById('closeModal');
            
            if (rulesHelpLink && rulesModal && closeModal) {
                rulesHelpLink.addEventListener('click', function(e) {
                    e.preventDefault();
                    rulesModal.style.display = 'flex';
                    document.body.style.overflow = 'hidden'; // é˜²æ­¢èƒŒæ™¯æ»šåŠ¨
                });
                
                closeModal.addEventListener('click', function() {
                    rulesModal.style.display = 'none';
                    document.body.style.overflow = 'auto'; // æ¢å¤èƒŒæ™¯æ»šåŠ¨
                });
                
                // ç‚¹å‡»æ¨¡æ€å¼¹çª—èƒŒæ™¯å…³é—­å¼¹çª—
                rulesModal.addEventListener('click', function(e) {
                    if (e.target === rulesModal) {
                        rulesModal.style.display = 'none';
                        document.body.style.overflow = 'auto';
                    }
                });
                
                // ESCé”®å…³é—­å¼¹çª—
                document.addEventListener('keydown', function(e) {
                    if (e.key === 'Escape' && rulesModal.style.display === 'flex') {
                        rulesModal.style.display = 'none';
                        document.body.style.overflow = 'auto';
                    }
                });
            }
        });
    </script>

    <!-- è¾“å…¥è§„åˆ™è¯´æ˜æ¨¡æ€å¼¹çª— -->
    <div id="rulesModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">è¾“å…¥è§„åˆ™è¯´æ˜</h2>
                <button class="modal-close" id="closeModal">&times;</button>
            </div>
            <div class="modal-body">
                <h3>åŸºæœ¬æ ¼å¼è§„åˆ™</h3>
                <ul>
                    <li><strong>ç¬¬ä¸€è¡Œ</strong>ï¼šè¡¨ç¤ºç”¨æˆ·çš„åç§°ï¼Œåœ¨å†…å®¹åé¢æ·»åŠ "<strong>11</strong>"ç»“å°¾</li>
                    <li><strong>ç¬¬äºŒè¡Œå¼€å§‹</strong>ï¼šä¸ºåŒæ–¹çš„èŠå¤©å†…å®¹ï¼Œé»˜è®¤ä¸ºç”¨æˆ·å‘é€çš„èŠå¤©å†…å®¹</li>
                    <li><strong>æˆ‘çš„å›å¤</strong>ï¼šç”±æˆ‘å›å¤çš„èŠå¤©å†…å®¹æ·»åŠ "<strong>22</strong>"ç»“å°¾</li>
                </ul>

                <h3>è¾“å…¥ç¤ºä¾‹</h3>
                <div class="example">
                    <div class="example-title">æ­£ç¡®çš„è¾“å…¥æ ¼å¼ï¼š</div>
å°ç‹11<br>
ä½ å¥½ï¼<br>
ä»Šå¤©å¤©æ°”çœŸä¸é”™22<br>
æ˜¯çš„ï¼Œè¦ä¸è¦ä¸€èµ·å‡ºå»èµ°èµ°ï¼Ÿ<br>
å¥½å•Šï¼Œä»€ä¹ˆæ—¶å€™ï¼Ÿ22<br>
ä¸‹åˆä¸‰ç‚¹æ€ä¹ˆæ ·ï¼Ÿ
                </div>

                <h3>æ³¨æ„äº‹é¡¹</h3>
                <ul>
                    <li>æ¯è¡Œä¸€æ¡æ¶ˆæ¯ï¼ŒæŒ‰æ—¶é—´é¡ºåºæ’åˆ—</li>
                    <li>ç”¨æˆ·åç§°åªéœ€åœ¨ç¬¬ä¸€è¡Œè®¾ç½®ä¸€æ¬¡</li>
                    <li>ä¸æ·»åŠ "22"ç»“å°¾çš„æ¶ˆæ¯é»˜è®¤ä¸ºç”¨æˆ·å‘é€</li>
                    <li>æ·»åŠ "22"ç»“å°¾çš„æ¶ˆæ¯è¡¨ç¤ºä¸ºæˆ‘çš„å›å¤</li>
                    <li>æ”¯æŒå¤šè¡Œæ–‡æœ¬ï¼Œå®æ—¶åŒæ­¥åˆ°å³ä¾§é¢„è§ˆåŒºåŸŸ</li>
                </ul>
            </div>
        </div>
    </div>

    <!-- åˆ é™¤ç¡®è®¤å¯¹è¯æ¡† -->
    <div id="deleteConfirmationOverlay" class="delete-confirmation-overlay">
        <div class="delete-confirmation-dialog">
            <div class="delete-confirmation-title">
                âš ï¸ ç¡®è®¤åˆ é™¤
            </div>
            <div id="deleteConfirmationMessage" class="delete-confirmation-message">
                ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„å†…å®¹å—ï¼Ÿæ­¤æ“ä½œå¯ä»¥æ’¤é”€ã€‚
            </div>
            <div class="delete-confirmation-actions">
                <button id="deleteConfirmationCancel" class="delete-confirmation-btn delete-confirmation-cancel">
                    å–æ¶ˆ
                </button>
                <button id="deleteConfirmationConfirm" class="delete-confirmation-btn delete-confirmation-confirm">
                    ç¡®è®¤åˆ é™¤
                </button>
            </div>
        </div>
    </div>

    <!-- æ’¤é”€é€šçŸ¥ -->
    <div id="undoNotification" class="undo-notification">
        <span id="undoMessage" class="undo-message">å·²åˆ é™¤å†…å®¹</span>
        <button id="undoBtn" class="undo-btn">æ’¤é”€</button>
        <button id="undoClose" class="undo-close">Ã—</button>
    </div>
</body>
</html>